<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>医学刷题 - 轻量版</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

<!-- GitHub 配置区 -->
<div id="github-config">
  <h3>GitHub 题库配置</h3>
  <p>仓库（如：user/repo）：<input type="text" id="repo" placeholder="owner/repo" /></p>
  <p>Token（私有仓库需要）：<input type="password" id="token" /></p>
  <p>路径（可选）：<input type="text" id="path" placeholder="questions/" /></p>
  <button id="load-list">加载题目列表</button>
  <div id="msg"></div>
</div>

<!-- 主界面（题库加载后显示） -->
<div id="main" style="display:none;">
  <h2>医学在线刷题</h2>
  <button id="show-collect">我的收藏</button>
  <button id="reset-all">重置进度</button>

  <div id="nav">
    <h4>分类</h4>
    <div id="categories"></div>
  </div>

  <div id="question-list">
    <h4>题目列表（仅文件名）</h4>
    <div id="list-items"></div>
  </div>

  <div id="current-question" style="margin-top:20px; padding:10px; border:1px solid #ccc;">
    <div id="question-content">请选择一道题目开始答题</div>
  </div>
</div>

<!-- 收藏弹窗（简单 div 模拟） -->
<div id="collect-modal" style="display:none; position:fixed; top:20%; left:20%; width:60%; background:#fff; border:2px solid #000; padding:20px; z-index:1000;">
  <h3>我的收藏</h3>
  <div id="collect-items"></div>
  <br><button id="close-collect">关闭</button>
</div>

<script>
$(function() {
  // ====== 配置 & 状态 ======
  const STORAGE = {
    config: 'jq_github_config',
    progress: 'jq_progress',
    collected: 'jq_collected',
    finished: 'jq_finished'
  };

  let fileList = [];       // 存储 {name, path, apiUrl} 的文件列表
  let questionsCache = {}; // 缓存已加载的题目 {filename => questionObj}
  let currentFile = null;
  let collected = JSON.parse(localStorage.getItem(STORAGE.collected) || '[]');
  let finished = JSON.parse(localStorage.getItem(STORAGE.finished) || '[]');

  // ====== 工具函数 ======
  function saveConfig() {
    localStorage.setItem(STORAGE.config, JSON.stringify({
      repo: $('#repo').val(),
      token: $('#token').val(),
      path: $('#path').val()
    }));
  }

  function loadConfig() {
    const cfg = JSON.parse(localStorage.getItem(STORAGE.config) || '{}');
    $('#repo').val(cfg.repo || '');
    $('#token').val(cfg.token || '');
    $('#path').val(cfg.path || '');
  }

  function showMessage(text, isError = false) {
    $('#msg').html(`<p style="color:${isError ? 'red' : 'green'};">${text}</p>`);
  }

  function getHeaders() {
    const token = $('#token').val();
    const headers = { 
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    };
    if (token) headers['Authorization'] = `token ${token}`;
    return headers;
  }

  // ====== 从 GitHub 获取 .json 文件列表 ======
  $('#load-list').on('click', async function() {
    const repo = $('#repo').val();
    if (!repo || !repo.includes('/')) {
      showMessage('请输入正确的仓库格式：owner/repo', true);
      return;
    }

    const [owner, name] = repo.split('/');
    const path = ($('#path').val() || '').trim();
    const apiUrl = `https://api.github.com/repos/${owner}/${name}/contents/${path}`;

    $('#msg').text('正在加载文件列表...');
    try {
      const res = await fetch(apiUrl, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
      
      const items = await res.json();
      fileList = items
        .filter(item => item.type === 'file' && item.name.endsWith('.json'))
        .map(item => ({ 
          name: item.name, 
          path: item.path,
          apiUrl: item.url
        }));

      if (fileList.length === 0) {
        showMessage('未找到 .json 题目文件', true);
        return;
      }

      renderQuestionList();
      $('#main').show();
      saveConfig();
      showMessage(`成功加载 ${fileList.length} 个题目文件`, false);
    } catch (err) {
      console.error(err);
      showMessage('加载失败：' + err.message, true);
    }
  });

  // ====== 渲染题目列表 ======
  function renderQuestionList() {
    let html = '';
    fileList.forEach((file, idx) => {
      const isCollected = collected.some(c => c.filename === file.name);
      const isFinished = finished.includes(file.name);
      html += `
        <div class="q-item" data-idx="${idx}" style="padding:5px; cursor:pointer; border-bottom:1px solid #eee;">
          ${idx + 1}. ${file.name}
          ${isCollected ? ' ⭐' : ''}
          ${isFinished ? ' ✅' : ''}
        </div>
      `;
    });
    $('#list-items').html(html);

    $('.q-item').on('click', function() {
      const idx = $(this).data('idx');
      loadAndShowQuestion(idx);
    });
  }

  // ====== 核心修复：加载题目（解决Base64换行+中文乱码） ======
  async function loadAndShowQuestion(idx) {
    const file = fileList[idx];
    currentFile = file;

    // 先检查缓存
    if (questionsCache[file.name]) {
      showQuestion(questionsCache[file.name]);
      return;
    }

    try {
      const res = await fetch(file.apiUrl, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
      
      const fileData = await res.json();
      // 修复1：清理Base64中的所有换行/空格，atob不支持含换行的Base64
      const cleanBase64 = fileData.content.replace(/\s+/g, '');
      // 修复2：先Base64解码为二进制，再通过UTF-8解析为字符串（解决中文乱码）
      const binaryStr = atob(cleanBase64);
      const uint8Array = new Uint8Array(binaryStr.length);
      for (let i = 0; i < binaryStr.length; i++) {
        uint8Array[i] = binaryStr.charCodeAt(i);
      }
      // 用UTF-8解码二进制数据，完美支持中文
      const jsonStr = new TextDecoder('utf-8').decode(uint8Array);
      const question = JSON.parse(jsonStr);
      
      questionsCache[file.name] = question;
      showQuestion(question);
    } catch (err) {
      $('#question-content').html(`<p style="color:red;">加载题目失败：${err.message}</p>`);
      console.error('加载题目详情失败：', err);
    }
  }

  // ====== 显示题目内容 ======
  function showQuestion(q) {
    let optionsHtml = '';
    q.option.forEach(opt => {
      const key = opt.charAt(0);
      optionsHtml += `<label><input type="radio" name="answer" value="${key}"> ${opt}</label><br>`;
    });

    let html = `
      <h3>${q.test}</h3>
      <div>${optionsHtml}</div>
      <button id="submit-btn">提交答案</button>
      <button id="collect-btn">${isCollected(q) ? '取消收藏' : '收藏'}</button>
      <div id="result"></div>
      <div id="analysis" style="margin-top:10px; display:none;">
        <p><strong>解析：</strong>${q.point || ''}</p>
        ${q.discuss ? `<p><strong>讨论：</strong>${q.discuss}</p>` : ''}
      </div>
    `;
    $('#question-content').html(html);

    // 绑定事件
    $('#submit-btn').on('click', () => submitAnswer(q));
    $('#collect-btn').on('click', () => toggleCollect(q));
  }

  function isCollected(q) {
    return collected.some(c => c.filename === currentFile.name);
  }

  function toggleCollect(q) {
    const idx = collected.findIndex(c => c.filename === currentFile.name);
    if (idx >= 0) {
      collected.splice(idx, 1);
    } else {
      collected.push({ filename: currentFile.name, ...q });
    }
    localStorage.setItem(STORAGE.collected, JSON.stringify(collected));
    renderQuestionList();
    $('#collect-btn').text(isCollected(q) ? '取消收藏' : '收藏');
  }

  function submitAnswer(q) {
    const selected = $('input[name="answer"]:checked').val();
    if (!selected) {
      alert('请选择一个答案');
      return;
    }

    const correct = selected === q.answer;
    $('#result').html(`
      <p style="color:${correct ? 'green' : 'red'};">
        ${correct ? '回答正确！' : '回答错误！'} 正确答案：${q.answer}
      </p>
    `);
    $('#analysis').show();

    if (!finished.includes(currentFile.name)) {
      finished.push(currentFile.name);
      localStorage.setItem(STORAGE.finished, JSON.stringify(finished));
      renderQuestionList();
    }

    if (fileList.indexOf(currentFile) < fileList.length - 1) {
      $('#question-content').append('<br><button id="next-btn">下一题</button>');
      $('#next-btn').on('click', () => {
        const nextIdx = fileList.indexOf(currentFile) + 1;
        loadAndShowQuestion(nextIdx);
      });
    }
  }

  // ====== 收藏列表 ======
  $('#show-collect').on('click', function() {
    let html = '';
    if (collected.length === 0) {
      html = '<p>暂无收藏</p>';
    } else {
      collected.forEach((item, i) => {
        html += `<div class="collect-item" data-i="${i}" style="padding:8px; border-bottom:1px solid #ddd; cursor:pointer;">
          ${item.test.substring(0, 50)}...
        </div>`;
      });
    }
    $('#collect-items').html(html);
    $('#collect-modal').show();

    $('.collect-item').on('click', function() {
      const i = $(this).data('i');
      const item = collected[i];
      const file = fileList.find(f => f.name === item.filename);
      if (file) {
        const idx = fileList.indexOf(file);
        loadAndShowQuestion(idx);
        $('#collect-modal').hide();
      }
    });
  });

  $('#close-collect').on('click', () => $('#collect-modal').hide());

  // ====== 重置 ======
  $('#reset-all').on('click', function() {
    if (confirm('确定重置所有进度和收藏？')) {
      localStorage.removeItem(STORAGE.finished);
      localStorage.removeItem(STORAGE.collected);
      finished = [];
      collected = [];
      renderQuestionList();
      $('#question-content').text('请选择一道题目开始答题');
    }
  });

  // ====== 初始化 ======
  loadConfig();
});
</script>

</body>
</html>