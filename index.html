<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>医学刷题 - 完整版</title>
<link rel="stylesheet" href="TokyoNightStorm.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

<aside id="sidebar">
    <div class="sidebar-header">
        <h2>医学刷题系统</h2>
    </div>
    <ul class="chapter-list" id="chapterList">
        <li class="chapter-item">
            <button class="chapter-btn active" id="load-config-btn">题库配置</button>
        </li>
        <li class="chapter-item" id="question-list-item" style="display:none;">
            <button class="chapter-btn" id="question-list-btn">题目列表</button>
            <ul class="section-list" id="question-section-list"></ul>
        </li>
    </ul>
</aside>

<button class="menu-toggle" onclick="toggleSidebar()">☰</button>

<main id="app-main">
    <div id="contentArea" class="content-container">
        <!-- GitHub 配置区 -->
        <div class="github-config" id="github-config">
            <h3>GitHub 题库配置</h3>
            <p>仓库（如：user/repo）：<input type="text" id="repo" placeholder="owner/repo" /></p>
            <p>Github Token（可选）：<input type="password" id="token" /></p>
            <p>路径（可选）：<input type="text" id="path" placeholder="questions/" /></p>
            <button id="load-list">加载题目列表</button><br/><br/>
            <select id="styleSelector">
                <option value="Original.css">默认风格</option>
                <option value="TokyoNightStorm.css">Tokyo Night Storm</option>
                <option value="ObsidianLite.css">Obsidian Lite</option>
                <option value="ObsidianDark.css">Obsidian Dark</option>
            </select>
        </div>

        <!-- 统计面板 -->
        <div class="stats-panel" id="stats-panel" style="display:none;">
            <h3>学习统计</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">总题数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completed-count">0</div>
                    <div class="stat-label">已完成</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="correct-count">0</div>
                    <div class="stat-label">答对</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wrong-count">0</div>
                    <div class="stat-label">错题</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracy-rate">0%</div>
                    <div class="stat-label">正确率</div>
                </div>
            </div>
        </div>

        <!-- 功能按钮区 -->
        <div class="func-buttons" id="func-buttons" style="display:none;">
            <button class="func-btn" id="show-collect">我的收藏</button>
            <button class="func-btn" id="reset-all">重置进度</button>
            <button class="func-btn" id="export-wrong">导出错题本</button>
            <button class="func-btn" id="open-dashboard">打开答题卡</button>
            <button class="func-btn" id="random-question">随机练习</button>
            <button class="func-btn" id="review-wrong">随机错题回顾</button>
        </div>

        <!-- 模式切换区 -->
        <div class="mode-controls" id="mode-controls" style="display:none;">
            <span>刷题模式：</span>
            <button class="mode-btn active" data-mode="recite">背题模式</button>
            <button class="mode-btn" data-mode="exam">答题模式</button>
        </div>
        <div id="msg" class="msg"></div>
        <!-- 题目展示区 -->
        <div id="question-content" style="margin-top: 30px;">
            <div style="text-align: center; margin-top: 50px; color: #6c757d;">
                <h2 style="margin-bottom: 20px;">请先配置并加载GitHub题库</h2>
                <p>填写仓库信息后点击「加载题目列表」开始刷题。</p>
            </div>
        </div>
    </div>
</main>

<!-- 答题卡弹窗 -->
<div id="dashboardModal" class="dashboard-modal" onclick="if(event.target === this) toggleDashboard()">
    <div class="dashboard-content">
        <div class="dashboard-header">
            <span class="dashboard-title">题目导航 (Question Dashboard)</span>
            <button class="dashboard-close" onclick="toggleDashboard()">&times;</button>
        </div>
        <div class="dashboard-legend">
            <div class="legend-item"><div class="dot correct"></div> 正确</div>
            <div class="legend-item"><div class="dot wrong"></div> 错误</div>
            <div class="legend-item"><div class="dot answered"></div> 已答</div>
            <div class="legend-item"><div class="dot empty"></div> 未答</div>
        </div>
        <div id="questionGrid" class="q-grid"></div>
    </div>
</div>

<!-- 收藏弹窗 -->
<div id="collectModal" class="collect-modal" onclick="if(event.target === this) toggleCollectModal()">
    <div class="collect-content">
        <div class="collect-header">
            <span class="collect-title">我的收藏</span>
            <button class="collect-close" onclick="toggleCollectModal()">&times;</button>
        </div>
        <div id="collect-items" class="collect-items"></div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 初始化：获取当前使用的CSS文件，并设置下拉框默认选中项
    var currentStyle = $('link[href$=".css"]').attr('href') || 'Original.css';
    $('#styleSelector').val(currentStyle);

    // 监听下拉选框的选择变化事件
    $('#styleSelector').change(function() {
        // 获取选中的新样式文件名
        var newStyle = $(this).val();
        // 修改CSS链接的href属性，切换样式
        $('link[href$=".css"]').attr('href', newStyle);
        
        // 可选：添加提示，告知用户样式已切换
        console.log('样式已切换为：', newStyle);
    });
});

$(function() {
    // 存储键名
    const STORAGE_KEYS = { 
        config: 'jq_github_config', 
        collected: 'jq_collected', 
        finished: 'jq_finished', 
        cache: 'jq_questions_cache', 
        wrong: 'jq_wrong_questions',
        stats: 'jq_stats'
    };

    // 全局状态
    let fileList = [], questionCache = JSON.parse(localStorage.getItem(STORAGE_KEYS.cache) || '{}');
    let currentFile = null, currentMode = 'recite'; // 默认背题模式
    let collected = JSON.parse(localStorage.getItem(STORAGE_KEYS.collected) || '[]');
    let finished = JSON.parse(localStorage.getItem(STORAGE_KEYS.finished) || '[]');
    let wrongQuestions = JSON.parse(localStorage.getItem(STORAGE_KEYS.wrong) || '[]'); // 错题本
    let excludedOptions = [], currentRepoInfo = { repo: '', path: '' };
    let currentStats = JSON.parse(localStorage.getItem(STORAGE_KEYS.stats) || '{"correct":0,"wrong":0,"total":0}');


    // 先读本地配置
    let cfg = {};
    try {
    const stored = localStorage.getItem(STORAGE_KEYS.config);
    if (stored) cfg = JSON.parse(stored);
    } catch (e) {
    console.error("Parse config failed:", e);
    }

    // 读URL参数并覆盖本地配置
    const encodedInfo = new URLSearchParams(window.location.search).get('i');
    if (encodedInfo) {
    try {
        const decoded = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(encodedInfo)))));
        if (decoded && typeof decoded === 'object') {
        cfg.repo = decoded.repo || cfg.repo;
        cfg.path = decoded.path || cfg.path;
        }
    } catch (e) {
        console.error("Decode URL param failed:", e);
    }
    }

    // 填充表单和全局变量
    $('#repo').val(cfg.repo || '');
    $('#token').val(cfg.token || '');
    $('#path').val(cfg.path || '');
    currentRepoInfo.repo = cfg.repo || '';
    currentRepoInfo.path = (cfg.path || '').trim();

    // 工具函数
    const showMsg = (text, isError) => {
        $('#msg').text(text).removeClass('success error').addClass(isError ? 'error' : 'success').show();
        setTimeout(() => $('#msg').fadeOut(), 3000);
    };

    const getHeaders = () => {
        const headers = { 'Accept': 'application/vnd.github.v3+json' };
        if ($('#token').val()) headers['Authorization'] = `token ${$('#token').val()}`;
        return headers;
    };

    const saveConfig = () => {
        const configData = { repo: $('#repo').val(), token: $('#token').val(), path: $('#path').val() };
        localStorage.setItem(STORAGE_KEYS.config, JSON.stringify(configData));
        currentRepoInfo.repo = configData.repo; 
        currentRepoInfo.path = (configData.path || '').trim();
    };

    const saveCache = () => { 
        try { localStorage.setItem(STORAGE_KEYS.cache, JSON.stringify(questionCache)); } 
        catch (e) { console.error('缓存保存失败', e); } 
    };

    const saveStats = () => {
        localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(currentStats));
    };

    const updateStatsDisplay = () => {
        const total = currentStats.total;
        const correct = currentStats.correct;
        const wrong = currentStats.wrong;
        const accuracyRate = total > 0 ? Math.round((correct / total) * 100) : 0;
        
        $('#total-count').text(total);
        $('#completed-count').text(finished.length);
        $('#correct-count').text(correct);
        $('#wrong-count').text(wrong);
        $('#accuracy-rate').text(`${accuracyRate}%`);
    };

    const isCollectMatchCurrentRepo = (item) => fileList.some(file => file.name === item.filename);

    // 预加载题目
    const preloadQuestions = async (currentIndex) => {
        const start = Math.max(0, currentIndex - 8);
        const end = Math.min(fileList.length - 1, currentIndex + 8);
        
        for (let i = start; i <= end; i++) {
            if (!questionCache[fileList[i].name]) {
                try {
                    const res = await fetch(fileList[i].apiUrl, { headers: getHeaders() });
                    if (!res.ok) continue;
                    
                    const fileData = await res.json();
                    const binaryStr = atob(fileData.content.replace(/\s+/g, ''));
                    const uint8Array = new Uint8Array(binaryStr.length);
                    for (let j = 0; j < binaryStr.length; j++) uint8Array[j] = binaryStr.charCodeAt(j);
                    const question = JSON.parse(new TextDecoder('utf-8').decode(uint8Array));
                    
                    questionCache[fileList[i].name] = question;
                } catch (err) {
                    console.error(`预加载题目失败: ${fileList[i].name}`, err);
                }
            }
        }
        saveCache();
    };

    // 刷新答题卡
    const refreshAnswerCard = () => {
        if (fileList.length === 0) { 
            $('#questionGrid').html('<div style="text-align:center; padding:20px; color:#666;">暂无题目</div>');
            return; 
        }
        let cardHtml = '';
        fileList.forEach((file, idx) => {
            const isAnswered = finished.includes(file.name);
            const isWrong = wrongQuestions.some(w => w.filename === file.name);
            let cardClass = 'q-grid-btn';
            if (isWrong) cardClass += ' wrong';
            else if (isAnswered) cardClass += ' answered';
            
            cardHtml += `<button class="${cardClass}" data-idx="${idx}">${idx+1}</button>`;
        });
        $('#questionGrid').html(cardHtml);
        // 答题卡点击跳转
        $('.q-grid-btn').click(function() { 
            loadQuestion($(this).data('idx'));
            toggleDashboard(); // 关闭答题卡
        });
    };

    // 加载GitHub题目列表
    $('#load-list').click(async function() {
        const repo = $('#repo').val();
        if (!repo || !repo.includes('/')) return showMsg('请输入正确的仓库格式：owner/repo', true);
        
        const [owner, name] = repo.split('/');
        const path = ($('#path').val() || '').trim();
        const apiUrl = `https://api.github.com/repos/${owner}/${name}/contents/${path}`;
        
        showMsg('少女祈祷中⋯⋯', false);
        $(this).prop('disabled', true).html('<span class="loading-spinner"></span> 少女祈祷中⋯⋯');
        
        // 读取repo和path的内容
        Info={ repo: repo, path: path };
        //Base64 Encode and log the Info object
        console.log('当前仓库信息：', Info);
        // url 添加参数i= base64编码后的Info对象，方便调试使用
        window.history.replaceState(null, '', `${window.location.pathname}?i=${encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(Info))))) }`);


        try {
            const res = await fetch(apiUrl, { headers: getHeaders() });
            if (!res.ok) throw new Error(`请求失败：${res.status}`);
            
            const items = await res.json();
            fileList = items.filter(item => item.type === 'file' && item.name.endsWith('.json'))
                            .map(item => ({ name: item.name, apiUrl: item.url }));

            if (fileList.length === 0) return showMsg('未找到JSON题目文件', true);
            
            // 渲染侧边栏题目列表
            renderQuestionSidebar();
            // 显示功能按钮和模式切换
            //$('#func-buttons, #mode-controls, #stats-panel').show();
            $('#stats-panel').show();
            // 显示题目列表侧边栏项
            $('#question-list-item').show();
            // 刷新答题卡
            refreshAnswerCard();
            // 更新统计数据
            currentStats.total = fileList.length;
            saveStats();
            updateStatsDisplay();
            // 清空题目展示区默认提示
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>请从左侧菜单选择题目开始刷题</p></div>');
            
            saveConfig();
            showMsg(`加载成功：${fileList.length} 个题目`, false);
        } catch (err) { 
            showMsg('加载失败：' + err.message, true); 
        } finally {
            $(this).prop('disabled', false).text('加载题目列表');
        }
    });

    // 渲染侧边栏题目列表
    const renderQuestionSidebar = () => {
        let html = '';
        fileList.forEach((file, idx) => {
            const isFinished = finished.includes(file.name);
            const isWrong = wrongQuestions.some(w => w.filename === file.name);
            const statusText = isWrong ? '[❌]' : isFinished ? '[✅]' : '';
            html += `<li><button class="section-btn" data-idx="${idx}">${idx + 1} ${statusText}</button></li>`;
        });
        $('#question-section-list').html(html);
        
        // 侧边栏题目点击事件
        $('.section-btn').click(function() {
            $('#load-config-btn').removeClass('active');
            $('#question-list-btn').addClass('active');
            $('#func-buttons, #mode-controls').show();

            $('.section-btn').removeClass('active');
            $(this).addClass('active');
            loadQuestion($(this).data('idx'));
            $('#github-config, #stats-panel').hide();
            // 移动端自动关闭侧边栏
            if ($(window).width() <= 992) {
                $('#sidebar').removeClass('open');
            }
        });
    };

    // 加载并显示题目
    const loadQuestion = async (idx) => {
        currentFile = fileList[idx]; 
        $('#question-content').html('<div style="text-align:center; padding:50px;"><p>少女祈祷中⋯⋯</p></div>'); 
        excludedOptions = [];

        try {
            let question = questionCache[currentFile.name];
            if (!question) { // 无缓存则从GitHub加载
                const res = await fetch(currentFile.apiUrl, { headers: getHeaders() });
                if (!res.ok) throw new Error(`请求失败：${res.status}`);
                
                const fileData = await res.json();
                const binaryStr = atob(fileData.content.replace(/\s+/g, ''));
                const uint8Array = new Uint8Array(binaryStr.length);
                for (let i = 0; i < binaryStr.length; i++) uint8Array[i] = binaryStr.charCodeAt(i);
                question = JSON.parse(new TextDecoder('utf-8').decode(uint8Array));
                
                questionCache[currentFile.name] = question; 
                saveCache();
            }
            showQuestion(question); // 渲染题目


            $('#next-btn').click(() => loadQuestion(Math.min(idx + 1, fileList.length - 1)));
            $('#prev-btn').click(() => loadQuestion(Math.max(idx - 1, 0)));
            // 启动预加载
            preloadQuestions(idx);
        } catch (err) { 
            $('#question-content').html(`<div style="color:var(--wrong-border); padding:20px;"><p>加载失败：${err.message}</p></div>`); 
        }
    };

    // 显示题目（适配新UI，区分背题/答题模式）
    const showQuestion = (q) => {
        // 构建选项HTML
        let optionsHtml = '';
        q.option.forEach((opt, optIdx) => {
            const key = opt.charAt(0);
            const isExcluded = excludedOptions.includes(optIdx);
            const optionClass = isExcluded ? 'option-excluded' : '';
            
            optionsHtml += `<li class="q-option ${optionClass}" data-opt-idx="${optIdx}" data-key="${key}">
                <span class="radio-circle"></span>
                <span class="opt-text">${opt}</span>
            </li>`;
        });

        // 收藏状态
        const isCollected = collected.some(c => c.filename === currentFile.name);
        const collectText = isCollected ? '取消收藏' : '收藏';

        // 解析HTML（区分模式）
        const analysisHtml = currentMode === 'exam' ? 
            '<div class="explanation" id="analysis"><div class="exp-header">答案解析</div><div class="exp-body"></div></div>' : 
            `<div class="explanation correct" id="analysis" style="display:block;">
                <div class="exp-header">答案解析</div>
                <div class="exp-body">
                    <p><strong>正确答案：</strong>${q.answer}</p>
                    <p><strong>解析：</strong>${q.point || '无解析'}</p>
                    ${q.discuss ? `<p><strong>讨论：</strong>${q.discuss}</p>` : ''}
                </div>
            </div>`;

        // 拼接题目卡片HTML
        const questionHtml = `<div class="q-card" id="q-card">
            <div class="q-meta">
                <span class="q-tag">${q.mode}</span>
                <span>题目 ${fileList.indexOf(currentFile) + 1}/${fileList.length}</span>
            </div><div class="q-text">${q.test}</div>
            <ul class="q-options" id="q-options">${optionsHtml}</ul>
            ${currentMode === 'exam' ? `
            <div class="multi-actions">
                <button class="multi-check-btn" id="submit-answer">提交答案</button>
                <button class="multi-check-btn" style="margin-left:10px;" id="collect-btn">${collectText}</button>
                <button class="multi-check-btn" style="margin-left:10px;" id="clear-exclude">清空排除</button>
            </div>` 
            
            : ''  // 背题模式不显示提交按钮
            }

                ${analysisHtml}
                <div id="next-btn-container" style="margin-top:20px;">
                <button class="case-confirm-btn" id="prev-btn">上一题</button>
                <button class="case-confirm-btn" id="next-btn">下一题</button>
            </div>
        </div>`;

        $('#question-content').html(questionHtml);

        // 绑定选项点击事件
        $('.q-option').click(function() {
            if ($('#q-options').hasClass('answered')) return; // 已提交则不可选
            // 取消其他选项选中状态
            $('.q-option').removeClass('selected-neutral');
            // 设置当前选项选中
            $(this).addClass('selected-neutral');
        });

        // 绑定右键排除选项事件
        $('.q-option').contextmenu(function(e) {
            e.preventDefault();
            const optIdx = parseInt($(this).data('opt-idx'));
            if (excludedOptions.includes(optIdx)) {
                excludedOptions = excludedOptions.filter(idx => idx !== optIdx);
                $(this).removeClass('option-excluded');
            } else { 
                excludedOptions.push(optIdx); 
                $(this).addClass('option-excluded'); 
            }
        });

        // 提交答案事件
        $('#submit-answer').click(() => checkAnswer(q));

        // 收藏事件
        $('#collect-btn').click(() => toggleCollect(q));


        // 清空排除事件
        $('#clear-exclude').click(() => {
            excludedOptions = [];
            $('.q-option').removeClass('option-excluded');
            showMsg('已清空排除选项', false);
        });
    };

    // 检查答案
    const checkAnswer = (q) => {
        const selectedOption = $('.q-option.selected-neutral');
        if (!selectedOption.length) return showMsg('请选择答案', true);
        
        const selectedKey = selectedOption.data('key');
        const isCorrect = selectedKey === q.answer;

        // 标记正确/错误选项
        $('.q-option').each(function() {
            const optKey = $(this).data('key');
            $(this).removeClass('selected-neutral');
            
            if (optKey === q.answer) {
                $(this).addClass('correct-answer');
            } else if (optKey === selectedKey && !isCorrect) {
                $(this).addClass('wrong-answer');
            }
        });

        // 标记已答题
        $('#q-options').addClass('answered');
        $('#q-card').addClass('answered');

        // 显示解析（答题模式）
        if (currentMode === 'exam') {
            const expClass = isCorrect ? 'correct' : 'wrong';
            const expHeader = isCorrect ? '回答正确 ✔' : '回答错误 ✘';
            const expBody = `
                <p><strong>正确答案：</strong>${q.answer}</p>
                <p><strong>你的答案：</strong>${selectedKey}</p>
                <p><strong>解析：</strong>${q.point || '无解析'}</p>
                ${q.discuss ? `<p><strong>讨论：</strong>${q.discuss}</p>` : ''}
            `;
            $('#analysis').removeClass('correct wrong').addClass(expClass);
            $('#analysis .exp-header').text(expHeader);
            $('#analysis .exp-body').html(expBody);
            $('#analysis').show();
        }

        // 记录完成状态
        if (!finished.includes(currentFile.name)) {
            finished.push(currentFile.name);
            localStorage.setItem(STORAGE_KEYS.finished, JSON.stringify(finished));
        }

        // 记录错题
        const isInWrong = wrongQuestions.some(w => w.filename === currentFile.name);
        if (!isCorrect && !isInWrong) {
            wrongQuestions.push({ filename: currentFile.name, repo: currentRepoInfo.repo, path: currentRepoInfo.path, ...q, userAnswer: selectedKey });
            localStorage.setItem(STORAGE_KEYS.wrong, JSON.stringify(wrongQuestions));
        }
        // 正确则移除错题
        if (isCorrect && isInWrong) {
            wrongQuestions = wrongQuestions.filter(w => w.filename !== currentFile.name);
            localStorage.setItem(STORAGE_KEYS.wrong, JSON.stringify(wrongQuestions));
        }

        // 更新统计
        if (!isCorrect && !isInWrong) {
            currentStats.wrong++;
        } else if (isCorrect && isInWrong) {
            currentStats.wrong--;
        }
        if (isCorrect && !finished.includes(currentFile.name)) {
            currentStats.correct++;
        }
        currentStats.total = fileList.length;
        saveStats();
        updateStatsDisplay();

        // 刷新侧边栏和答题卡
        renderQuestionSidebar();
        refreshAnswerCard();

        // 显示下一题按钮
        const currentIdx = fileList.indexOf(currentFile);
        if (currentIdx < fileList.length - 1) {
            $('#next-btn-container').show();
        }
    };

    // 收藏/取消收藏
    const toggleCollect = (q) => {
        const idx = collected.findIndex(c => c.filename === currentFile.name);
        if (idx >= 0) {
            collected.splice(idx, 1);
            $('#collect-btn').text('收藏');
        } else {
            collected.push({ filename: currentFile.name, repo: currentRepoInfo.repo, path: currentRepoInfo.path, ...q });
            $('#collect-btn').text('取消收藏');
        }
        localStorage.setItem(STORAGE_KEYS.collected, JSON.stringify(collected));
        showMsg(idx >= 0 ? '取消收藏成功' : '收藏成功', false);
    };

    // 模式切换
    $('.mode-btn').click(function() {
        $('.mode-btn').removeClass('active');
        $(this).addClass('active');
        currentMode = $(this).data('mode');
        
        // 刷新当前题目
        if (currentFile) {
            const currentIdx = fileList.indexOf(currentFile);
            loadQuestion(currentIdx);
        }
    });

    // 导出错题本
    $('#export-wrong').click(function() {
        if (wrongQuestions.length === 0) return showMsg('暂无错题！', true);
        
        const wrongJson = JSON.stringify(wrongQuestions, null, 2);
        const blob = new Blob([wrongJson], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `医学刷题-错题本-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        
        showMsg('错题本导出成功！', false);
    });

    // 收藏列表
    $('#show-collect').click(function() {
        const matchedCollects = collected.filter(isCollectMatchCurrentRepo);
        let html = '';
        
        if (matchedCollects.length === 0) {
            html = '<div style="padding:20px; text-align:center; color:#666;">暂无当前仓库的收藏题目</div>';
        } else {
            matchedCollects.forEach((item, i) => {
                html += `<div class="collect-item" data-i="${i}">
                    <strong>${i+1}.</strong> ${item.test.substring(0, 60)}...
                </div>`;
            });
        }
        
        $('#collect-items').html(html);
        toggleCollectModal(true);

        // 收藏项点击事件
        $('.collect-item').click(function() {
            const item = matchedCollects[$(this).data('i')];
            const file = fileList.find(f => f.name === item.filename);
            if (file) { 
                loadQuestion(fileList.indexOf(file));
                toggleCollectModal(false);
            }
        });
    });

    // 随机练习
    $('#random-question').click(function() {
        if (fileList.length === 0) {
            showMsg('请先加载题目', true);
            return;
        }
        const randomIdx = Math.floor(Math.random() * fileList.length);
        loadQuestion(randomIdx);
    });

    // 错题回顾
    $('#review-wrong').click(function() {
        if (wrongQuestions.length === 0) {
            showMsg('暂无错题', true);
            return;
        }
        // 过滤出当前仓库的错题
        const currentRepoWrong = wrongQuestions.filter(w => 
            w.repo === currentRepoInfo.repo && 
            w.path === currentRepoInfo.path
        );
        
        if (currentRepoWrong.length === 0) {
            showMsg('当前仓库暂无错题', true);
            return;
        }
        
        // 随机选择一道错题
        const randomWrong = currentRepoWrong[Math.floor(Math.random() * currentRepoWrong.length)];
        const file = fileList.find(f => f.name === randomWrong.filename);
        
        if (file) {
            loadQuestion(fileList.indexOf(file));
        } else {
            showMsg('题目不存在', true);
        }
    });

    // 重置所有数据
    $('#reset-all').click(function() {
        if (confirm('确定重置所有进度、收藏、错题和缓存？')) {
            Object.keys(STORAGE_KEYS).forEach(key => localStorage.removeItem(STORAGE_KEYS[key]));
            collected = []; 
            finished = []; 
            wrongQuestions = []; 
            questionCache = {}; 
            excludedOptions = [];
            currentStats = { correct: 0, wrong: 0, total: 0 };
            
            renderQuestionSidebar();
            refreshAnswerCard();
            updateStatsDisplay();
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>所有数据已重置，请重新选择题目</p></div>');
            
            showMsg('所有数据已重置！', false);
        }
    });

    // 侧边栏切换
    $('#load-config-btn, #question-list-btn').click(function() {
        $('.chapter-btn').removeClass('active');
        $(this).addClass('active');
        
        if ($(this).attr('id') === 'load-config-btn') {
            $('#github-config, #stats-panel').show();
            $('#func-buttons, #mode-controls').hide();
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><h2 style="margin-bottom: 20px;">请先配置并加载GitHub题库</h2><p>填写仓库信息后点击「加载题目列表」开始刷题。</p></div>');
        } else {
            $('#github-config, #stats-panel').hide();
            $('#func-buttons, #mode-controls').show();
            if (fileList.length === 0) {
                $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>暂无题目，请先加载GitHub题库</p></div>');
            }
        }

        // 移动端自动关闭侧边栏
        if ($(window).width() <= 992) {
            $('#sidebar').removeClass('open');
        }
    });
    
    // 初始化统计显示
    updateStatsDisplay();
});

// 侧边栏切换（移动端）
function toggleSidebar() {
    $('#sidebar').toggleClass('open');
}

// 答题卡弹窗切换
function toggleDashboard() {
    $('#dashboardModal').toggleClass('open');
    if ($('#dashboardModal').hasClass('open')) {
        $('#dashboardModal').css('display', 'flex');
    } else {
        $('#dashboardModal').css('display', 'none');
    }
}

// 打开答题卡
$(function() {
    $('#open-dashboard').click(function() {
        $('#dashboardModal').addClass('open').css('display', 'flex');
    });
});

// 收藏弹窗切换
function toggleCollectModal(show) {
    if (show === true) {
        $('#collectModal').addClass('open').css('display', 'flex');
    } else if (show === false) {
        $('#collectModal').removeClass('open').css('display', 'none');
    } else {
        $('#collectModal').toggleClass('open');
        if ($('#collectModal').hasClass('open')) {
            $('#collectModal').css('display', 'flex');
        } else {
            $('#collectModal').css('display', 'none');
        }
    }
}
</script>
</body>
</html>



