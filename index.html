<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>医学刷题 - 完整版</title>
<style>
    :root {
        --primary-color: #005f73; 
        --secondary-color: #0a9396; 
        --accent-color: #e0fbfc;
        --correct-bg: #e6fffa; 
        --correct-border: #2a9d8f;
        --wrong-bg: #fff5f5; 
        --wrong-border: #e63946;
        --text-color: #2b2d42; 
        --bg-color: #f8f9fa; 
        --card-bg: #ffffff;
        --border-color: #dee2e6; 
        --font-main: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
        --sidebar-width: 300px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; display: flex; height: 100vh; overflow: hidden; }
    
    /* Sidebar */
    aside { 
        width: var(--sidebar-width); 
        background: #fff; 
        border-right: 1px solid var(--border-color); 
        height: 100vh; 
        display: flex;
        flex-direction: column;
        z-index: 1000;
        transition: transform 0.3s ease;
        box-shadow: 2px 0 10px rgba(0,0,0,0.03);
    }
    
    .sidebar-header {
        padding: 20px 15px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-color);
        flex-shrink: 0;
    }
    .sidebar-header h2 {
        font-size: 1.1rem; 
        color: var(--primary-color); 
        font-weight: 700;
        margin: 0;
    }

    .chapter-list {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        list-style: none;
    }

    .chapter-item { 
        margin-bottom: 5px; 
    }
    
    .chapter-btn { 
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
        text-decoration: none; 
        color: var(--text-color); 
        font-size: 0.95rem; 
        display: block; 
        padding: 12px 15px; 
        border-radius: 8px; 
        transition: all 0.2s; 
        border-left: 4px solid transparent; 
        font-weight: 500;
        line-height: 1.4;
    }
    
    .chapter-btn:hover { background-color: var(--accent-color); color: var(--primary-color); }
    .chapter-btn.active { background-color: var(--accent-color); color: var(--primary-color); font-weight: 700; border-left-color: var(--secondary-color); }

    /* Sub-sections (Sub-directory) */
    .section-list {
        list-style: none;
        margin-left: 15px;
        padding-left: 10px;
        border-left: 2px solid #f0f0f0;
        margin-top: 5px;
        margin-bottom: 10px;
        display: none;
    }
    
    .chapter-item.expanded .section-list {
        display: block;
        animation: fadeIn 0.3s;
    }

    .section-btn {
        display: block;
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        padding: 8px 10px;
        font-size: 0.85rem;
        color: #666;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s;
        line-height: 1.3;
    }
    
    .section-btn:hover {
        color: var(--primary-color);
        background-color: #f8f9fa;
    }
    
    .section-btn.active {
        color: var(--primary-color) !important;
        font-weight: 700 !important;
        background-color: #f0f9ff !important;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    /* Main Content Area */
    #app-main { 
        flex: 1; 
        position: relative;
        height: 100vh;
        overflow-y: auto;
        scroll-behavior: smooth;
    }

    .content-container {
        padding: 40px; 
        max-width: 960px; 
        margin: 0 auto;
        min-height: 100%;
        padding-bottom: 100px;
    }

    header.chapter-header { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    header.chapter-header h1 { color: var(--primary-color); font-size: 2rem; margin-bottom: 5px; font-weight: 700; line-height: 1.3; }
    .chapter-subtitle { color: #666; font-size: 1rem; margin-bottom: 15px; margin-top: 0; line-height: 1.5; }
    
    /* Mode Controls */
    .mode-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .mode-btn { 
        padding: 8px 16px; 
        border: 1px solid var(--primary-color); 
        background: transparent; 
        color: var(--primary-color); 
        border-radius: 6px; 
        cursor: pointer; 
        transition: all 0.2s; 
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .mode-btn:hover { background-color: var(--accent-color); }
    .mode-btn.active { background: var(--primary-color); color: #fff; box-shadow: 0 2px 5px rgba(0,95,115,0.3); }

    /* Case Context Styles */
    .case-context { 
        background-color: #f1f8fd; 
        border-left: 5px solid var(--primary-color); 
        padding: 20px; 
        border-radius: 8px; 
        margin-bottom: 30px; 
        scroll-margin-top: 20px; 
        font-size: 0.95rem;
    }
    .case-title { 
        font-weight: 700; color: var(--primary-color); display: block; 
        margin-top: 40px; margin-bottom: 15px; font-size: 1.4rem; 
        border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; scroll-margin-top: 60px;
    }
    .case-context .case-title { border-bottom: none; margin-top: 0; font-size: 1.1rem; padding-bottom: 5px; }

    /* Question Cards */
    .q-card { background: var(--card-bg); border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 1px solid var(--border-color); position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.2s; scroll-margin-top: 80px; }
    .q-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
    
    .q-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.85rem; color: #8d99ae; font-weight: 600; text-transform: uppercase; }
    .q-tag { background: #edf2f4; padding: 4px 10px; border-radius: 4px; color: var(--primary-color); font-size: 0.75rem; font-weight: bold; margin-right: 10px; }
    
    .q-text { font-size: 1.15rem; font-weight: 600; margin-bottom: 25px; color: #2b2d42; line-height: 1.5; }
    
    .q-options { list-style: none; margin-bottom: 25px; }
    .q-option { margin-bottom: 12px; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; display: flex; align-items: flex-start; transition: all 0.2s; font-size: 0.95rem; position: relative; line-height: 1.5; }
    .q-option:hover { background-color: #f8f9fa; border-color: var(--secondary-color); }
    
    /* Icons */
    .radio-circle { width: 20px; height: 20px; border: 2px solid #adb5bd; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: all 0.2s; }
    .radio-circle::after { content: ''; width: 10px; height: 10px; background: var(--primary-color); border-radius: 50%; opacity: 0; transform: scale(0); transition: all 0.2s; }
    
    .checkbox-square { width: 20px; height: 20px; border: 2px solid #adb5bd; border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: all 0.2s; }
    .checkbox-square::after { content: '✓'; font-size: 14px; color: white; display: none; line-height: 1; }

    /* Selection States */
    .q-option.selected-neutral { background-color: #e7f5ff; border-color: #74c0fc; }
    .q-option.selected-neutral .radio-circle { border-color: #74c0fc; }
    .q-option.selected-neutral .radio-circle::after { background: #74c0fc; opacity: 1; transform: scale(1); }
    .q-option.selected-neutral .checkbox-square { border-color: #74c0fc; background-color: #74c0fc; }
    .q-option.selected-neutral .checkbox-square::after { display: block; }
    
    /* Study Mode Selection */
    .q-option.selected .radio-circle::after { opacity: 1; transform: scale(1); }
    .q-option.selected .checkbox-square { background-color: var(--secondary-color); border-color: var(--secondary-color); }
    .q-option.selected .checkbox-square::after { display: block; }

    /* Answer Results */
    .q-options.answered .q-option, .q-card.answered .q-option { cursor: default; }
    .q-options.answered .q-option:hover, .q-card.answered .q-option:hover { background-color: initial; border-color: #e9ecef; }
    
    .q-option.correct-answer { border-color: var(--correct-border) !important; background-color: var(--correct-bg) !important; color: #155724; }
    .q-option.correct-answer .radio-circle { border-color: var(--correct-border); }
    .q-option.correct-answer .radio-circle::after { background: var(--correct-border); opacity: 1; transform: scale(1); }
    .q-option.correct-answer .checkbox-square { border-color: var(--correct-border); background-color: var(--correct-border); }
    .q-option.correct-answer .checkbox-square::after { display: block; }

    .q-option.wrong-answer { border-color: var(--wrong-border) !important; background-color: var(--wrong-bg) !important; color: #721c24; }
    .q-option.wrong-answer .radio-circle { border-color: var(--wrong-border); } 
    .q-option.wrong-answer .radio-circle::after { background: var(--wrong-border); opacity: 1; transform: scale(1); }
    .q-option.wrong-answer .checkbox-square { border-color: var(--wrong-border); background-color: var(--wrong-border); }
    .q-option.wrong-answer .checkbox-square::after { display: block; }
    
    /* Multi-Choice Actions */
    .multi-actions { margin-bottom: 20px; }
    .multi-check-btn { 
        padding: 8px 20px; background-color: var(--secondary-color); color: white; 
        border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;
        transition: background 0.2s;
    }
    .multi-check-btn:hover { background-color: var(--primary-color); }
    .answered .multi-actions { display: none; }
    
    /* Explanation */
    .explanation { margin-top: 25px; border-radius: 8px; overflow: hidden; display: none; font-size: 0.9rem; line-height: 1.6; animation: slideDown 0.3s ease-out; }
    .explanation.correct { background: var(--correct-bg); border: 1px solid var(--correct-border); }
    .explanation.wrong { background: var(--wrong-bg); border: 1px solid var(--wrong-border); }
    .exp-header { padding: 12px 20px; font-weight: bold; display: flex; align-items: center; }
    .explanation.correct .exp-header { background-color: rgba(42, 157, 143, 0.1); color: #2a9d8f; }
    .explanation.wrong .exp-header { background-color: rgba(230, 57, 70, 0.1); color: #e63946; }
    .exp-body { padding: 20px; font-size: 0.95rem; color: #495057; }
    
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* Progress & Submit */
    .progress-container { height: 8px; background: #e9ecef; border-radius: 4px; margin-top: 20px; overflow:hidden; }
    .progress-bar { height: 100%; background: var(--secondary-color); width: 0%; transition: width 0.3s; }
    .submit-container { text-align: center; margin: 40px 0 60px 0; }
    .submit-btn { background: var(--primary-color); color: white; border: none; padding: 14px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,95,115,0.3); }
    .submit-btn:hover { background: #077b93; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,95,115,0.4); }

    /* Dashboard (Answer Sheet) Overlay */
    .dashboard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .dashboard-modal.open { opacity: 1; }
    .dashboard-content { background: white; width: 90%; max-width: 600px; max-height: 80vh; border-radius: 12px; padding: 25px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.2s; }
    .dashboard-modal.open .dashboard-content { transform: scale(1); }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .dashboard-title { font-size: 1.2rem; font-weight: bold; color: var(--text-color); }
    .dashboard-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
    .dashboard-legend { display: flex; gap: 15px; margin-bottom: 15px; font-size: 0.85rem; color: #666; justify-content: center; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .dot { width: 12px; height: 12px; border-radius: 50%; }
    .dot.correct { background: var(--correct-bg); border: 1px solid var(--correct-border); }
    .dot.wrong { background: var(--wrong-bg); border: 1px solid var(--wrong-border); }
    .dot.answered { background: #e7f5ff; border: 1px solid #74c0fc; }
    .dot.empty { border: 1px solid #dee2e6; }
    
    .q-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; overflow-y: auto; padding: 5px; }
    .q-grid-btn { width: 45px; height: 45px; border-radius: 8px; border: 1px solid #dee2e6; background: white; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
    .q-grid-btn:hover { border-color: var(--secondary-color); color: var(--secondary-color); transform: translateY(-2px); }
    
    .q-grid-btn.correct { background-color: var(--correct-bg); border-color: var(--correct-border); color: #0f5132; }
    .q-grid-btn.wrong { background-color: var(--wrong-bg); border-color: var(--wrong-border); color: #842029; }
    .q-grid-btn.answered { background-color: #e7f5ff; border-color: #74c0fc; color: #1864ab; } /* For Exam Mode before submit */

    /* Case Study Exam */
    .case-hidden { display: none !important; }
    .locked-case-q .q-options { opacity: 0.6; pointer-events: none; filter: grayscale(0.5); }
    .case-confirm-btn { margin-top: 20px; padding: 10px 25px; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    /* Mobile Toggle */
    .menu-toggle { display: none; position: fixed; bottom: 20px; right: 20px; background: var(--primary-color); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000; font-size: 24px; cursor: pointer; }
    
    /* GitHub Config Area */
    .github-config {
        padding: 20px;
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .github-config h3 {
        color: var(--primary-color);
        margin-bottom: 15px;
        font-size: 1.2rem;
    }
    .github-config p {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .github-config input {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        flex: 1;
        font-size: 0.9rem;
    }
    .github-config button {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    .github-config button:hover {
        background: #077b93;
    }
    .msg {
        margin-top: 15px;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    .msg.error {
        background: var(--wrong-bg);
        color: var(--wrong-border);
        border: 1px solid var(--wrong-border);
    }
    .msg.success {
        background: var(--correct-bg);
        color: var(--correct-border);
        border: 1px solid var(--correct-border);
    }

    /* Function Buttons */
    .func-buttons {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    .func-btn {
        padding: 8px 16px;
        border: 1px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .func-btn:hover {
        background-color: var(--accent-color);
    }

    /* Excluded Option (右键排除) */
    .q-option.option-excluded {
        color: #999;
        text-decoration: line-through;
        cursor: not-allowed;
        opacity: 0.7;
    }
    .q-option.option-excluded .radio-circle {
        border-color: #ccc;
    }

    /* Collect Modal */
    .collect-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 3000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .collect-modal.open {
        opacity: 1;
    }
    .collect-content {
        background: white;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        border-radius: 12px;
        padding: 25px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        transform: scale(0.95);
        transition: transform 0.2s;
    }
    .collect-modal.open .collect-content {
        transform: scale(1);
    }
    .collect-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .collect-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--text-color);
    }
    .collect-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
    }
    .collect-items {
        overflow-y: auto;
        flex: 1;
    }
    .collect-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: all 0.2s;
    }
    .collect-item:hover {
        background-color: var(--accent-color);
    }

    @media (max-width: 992px) { 
        aside { position: fixed; transform: translateX(-100%); width: 80%; max-width: 300px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); } 
        aside.open { transform: translateX(0); }
        .menu-toggle { display: flex; align-items: center; justify-content: center; }
        .content-container { padding: 20px; padding-bottom: 80px; }
    }
</style>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

<aside id="sidebar">
    <div class="sidebar-header">
        <h2>医学刷题系统</h2>
    </div>
    <ul class="chapter-list" id="chapterList">
        <li class="chapter-item">
            <button class="chapter-btn active" id="load-config-btn">题库配置</button>
        </li>
        <li class="chapter-item" id="question-list-item" style="display:none;">
            <button class="chapter-btn" id="question-list-btn">题目列表</button>
            <ul class="section-list" id="question-section-list"></ul>
        </li>
    </ul>
</aside>

<button class="menu-toggle" onclick="toggleSidebar()">☰</button>

<main id="app-main">
    <div id="contentArea" class="content-container">
        <!-- GitHub 配置区 -->
        <div class="github-config" id="github-config">
            <h3>GitHub 题库配置</h3>
            <p>仓库（如：user/repo）：<input type="text" id="repo" placeholder="owner/repo" /></p>
            <p>Token（私有仓库需要）：<input type="password" id="token" /></p>
            <p>路径（可选）：<input type="text" id="path" placeholder="questions/" /></p>
            <button id="load-list">加载题目列表</button>
            <div id="msg" class="msg"></div>
        </div>

        <!-- 功能按钮区 -->
        <div class="func-buttons" id="func-buttons" style="display:none;">
            <button class="func-btn" id="show-collect">我的收藏</button>
            <button class="func-btn" id="reset-all">重置进度</button>
            <button class="func-btn" id="export-wrong">导出错题本</button>
            <button class="func-btn" id="open-dashboard">打开答题卡</button>
        </div>

        <!-- 模式切换区 -->
        <div class="mode-controls" id="mode-controls" style="display:none;">
            <span>刷题模式：</span>
            <button class="mode-btn active" data-mode="recite">背题模式</button>
            <button class="mode-btn" data-mode="exam">考试模式</button>
        </div>

        <!-- 题目展示区 -->
        <div id="question-content" style="margin-top: 30px;">
            <div style="text-align: center; margin-top: 50px; color: #6c757d;">
                <h2 style="margin-bottom: 20px;">请先配置并加载GitHub题库</h2>
                <p>填写仓库信息后点击「加载题目列表」开始刷题。</p>
            </div>
        </div>
    </div>
</main>

<!-- 答题卡弹窗 -->
<div id="dashboardModal" class="dashboard-modal" onclick="if(event.target === this) toggleDashboard()">
    <div class="dashboard-content">
        <div class="dashboard-header">
            <span class="dashboard-title">题目导航 (Question Dashboard)</span>
            <button class="dashboard-close" onclick="toggleDashboard()">&times;</button>
        </div>
        <div class="dashboard-legend">
            <div class="legend-item"><div class="dot correct"></div> 正确</div>
            <div class="legend-item"><div class="dot wrong"></div> 错误</div>
            <div class="legend-item"><div class="dot answered"></div> 已答</div>
            <div class="legend-item"><div class="dot empty"></div> 未答</div>
        </div>
        <div id="questionGrid" class="q-grid"></div>
    </div>
</div>

<!-- 收藏弹窗 -->
<div id="collectModal" class="collect-modal" onclick="if(event.target === this) toggleCollectModal()">
    <div class="collect-content">
        <div class="collect-header">
            <span class="collect-title">我的收藏</span>
            <button class="collect-close" onclick="toggleCollectModal()">&times;</button>
        </div>
        <div id="collect-items" class="collect-items"></div>
    </div>
</div>

<script>
$(function() {
    // 存储键名
    const STORAGE_KEYS = { 
        config: 'jq_github_config', 
        collected: 'jq_collected', 
        finished: 'jq_finished', 
        cache: 'jq_questions_cache', 
        wrong: 'jq_wrong_questions' 
    };

    // 全局状态
    let fileList = [], questionCache = JSON.parse(localStorage.getItem(STORAGE_KEYS.cache) || '{}');
    let currentFile = null, currentMode = 'recite'; // 默认背题模式
    let collected = JSON.parse(localStorage.getItem(STORAGE_KEYS.collected) || '[]');
    let finished = JSON.parse(localStorage.getItem(STORAGE_KEYS.finished) || '[]');
    let wrongQuestions = JSON.parse(localStorage.getItem(STORAGE_KEYS.wrong) || '[]'); // 错题本
    let excludedOptions = [], currentRepoInfo = { repo: '', path: '' };

    // 初始化配置
    const cfg = JSON.parse(localStorage.getItem(STORAGE_KEYS.config) || '{}');
    $('#repo').val(cfg.repo || ''); 
    $('#token').val(cfg.token || ''); 
    $('#path').val(cfg.path || '');
    currentRepoInfo.repo = cfg.repo || ''; 
    currentRepoInfo.path = (cfg.path || '').trim();

    // 工具函数
    const showMsg = (text, isError) => {
        $('#msg').text(text).removeClass('success error').addClass(isError ? 'error' : 'success').show();
        setTimeout(() => $('#msg').fadeOut(), 3000);
    };

    const getHeaders = () => {
        const headers = { 'Accept': 'application/vnd.github.v3+json' };
        if ($('#token').val()) headers['Authorization'] = `token ${$('#token').val()}`;
        return headers;
    };

    const saveConfig = () => {
        const configData = { repo: $('#repo').val(), token: $('#token').val(), path: $('#path').val() };
        localStorage.setItem(STORAGE_KEYS.config, JSON.stringify(configData));
        currentRepoInfo.repo = configData.repo; 
        currentRepoInfo.path = (configData.path || '').trim();
    };

    const saveCache = () => { 
        try { localStorage.setItem(STORAGE_KEYS.cache, JSON.stringify(questionCache)); } 
        catch (e) { console.error('缓存保存失败', e); } 
    };

    const isCollectMatchCurrentRepo = (item) => fileList.some(file => file.name === item.filename);

    // 刷新答题卡
    const refreshAnswerCard = () => {
        if (fileList.length === 0) { 
            $('#questionGrid').html('<div style="text-align:center; padding:20px; color:#666;">暂无题目</div>');
            return; 
        }
        let cardHtml = '';
        fileList.forEach((file, idx) => {
            const isAnswered = finished.includes(file.name);
            const isWrong = wrongQuestions.some(w => w.filename === file.name);
            let cardClass = 'q-grid-btn';
            if (isWrong) cardClass += ' wrong';
            else if (isAnswered) cardClass += ' answered';
            
            cardHtml += `<button class="${cardClass}" data-idx="${idx}">${idx+1}</button>`;
        });
        $('#questionGrid').html(cardHtml);
        // 答题卡点击跳转
        $('.q-grid-btn').click(function() { 
            loadQuestion($(this).data('idx'));
            toggleDashboard(); // 关闭答题卡
        });
    };

    // 加载GitHub题目列表
    $('#load-list').click(async function() {
        const repo = $('#repo').val();
        if (!repo || !repo.includes('/')) return showMsg('请输入正确的仓库格式：owner/repo', true);
        
        const [owner, name] = repo.split('/');
        const path = ($('#path').val() || '').trim();
        const apiUrl = `https://api.github.com/repos/${owner}/${name}/contents/${path}`;
        
        showMsg('加载中...', false);
        try {
            const res = await fetch(apiUrl, { headers: getHeaders() });
            if (!res.ok) throw new Error(`请求失败：${res.status}`);
            
            const items = await res.json();
            fileList = items.filter(item => item.type === 'file' && item.name.endsWith('.json'))
                            .map(item => ({ name: item.name, apiUrl: item.url }));

            if (fileList.length === 0) return showMsg('未找到JSON题目文件', true);
            
            // 渲染侧边栏题目列表
            renderQuestionSidebar();
            // 显示功能按钮和模式切换
            $('#func-buttons, #mode-controls').show();
            // 显示题目列表侧边栏项
            $('#question-list-item').show();
            // 刷新答题卡
            refreshAnswerCard();
            // 清空题目展示区默认提示
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>请从左侧菜单选择题目开始刷题</p></div>');
            
            saveConfig();
            showMsg(`加载成功：${fileList.length} 个题目`, false);
        } catch (err) { 
            showMsg('加载失败：' + err.message, true); 
        }
    });

    // 渲染侧边栏题目列表
    const renderQuestionSidebar = () => {
        let html = '';
        fileList.forEach((file, idx) => {
            const isFinished = finished.includes(file.name);
            const isWrong = wrongQuestions.some(w => w.filename === file.name);
            const statusText = isWrong ? '[错题]' : isFinished ? '[已答]' : '';
            html += `<li><button class="section-btn" data-idx="${idx}">${idx + 1}. ${file.name} ${statusText}</button></li>`;
        });
        $('#question-section-list').html(html);
        
        // 侧边栏题目点击事件
        $('.section-btn').click(function() {
            $('.section-btn').removeClass('active');
            $(this).addClass('active');
            loadQuestion($(this).data('idx'));
            // 移动端自动关闭侧边栏
            if ($(window).width() <= 992) {
                $('#sidebar').removeClass('open');
            }
        });
    };

    // 加载并显示题目
    const loadQuestion = async (idx) => {
        currentFile = fileList[idx]; 
        $('#question-content').html('<div style="text-align:center; padding:50px;"><p>加载中...</p></div>'); 
        excludedOptions = [];

        try {
            let question = questionCache[currentFile.name];
            if (!question) { // 无缓存则从GitHub加载
                const res = await fetch(currentFile.apiUrl, { headers: getHeaders() });
                if (!res.ok) throw new Error(`请求失败：${res.status}`);
                
                const fileData = await res.json();
                const binaryStr = atob(fileData.content.replace(/\s+/g, ''));
                const uint8Array = new Uint8Array(binaryStr.length);
                for (let i = 0; i < binaryStr.length; i++) uint8Array[i] = binaryStr.charCodeAt(i);
                question = JSON.parse(new TextDecoder('utf-8').decode(uint8Array));
                
                questionCache[currentFile.name] = question; 
                saveCache();
            }
            showQuestion(question); // 渲染题目
        } catch (err) { 
            $('#question-content').html(`<div style="color:var(--wrong-border); padding:20px;"><p>加载失败：${err.message}</p></div>`); 
        }
    };

    // 显示题目（适配新UI，区分背题/考试模式）
    const showQuestion = (q) => {
        // 构建选项HTML
        let optionsHtml = '';
        q.option.forEach((opt, optIdx) => {
            const key = opt.charAt(0);
            const isExcluded = excludedOptions.includes(optIdx);
            const optionClass = isExcluded ? 'option-excluded' : '';
            
            optionsHtml += `<li class="q-option ${optionClass}" data-opt-idx="${optIdx}" data-key="${key}">
                <span class="radio-circle"></span>
                <span class="opt-text">${opt}</span>
            </li>`;
        });

        // 收藏状态
        const isCollected = collected.some(c => c.filename === currentFile.name);
        const collectText = isCollected ? '取消收藏' : '收藏';

        // 解析HTML（区分模式）
        const analysisHtml = currentMode === 'exam' ? 
            '<div class="explanation" id="analysis"><div class="exp-header">答案解析</div><div class="exp-body"></div></div>' : 
            `<div class="explanation correct" id="analysis" style="display:block;">
                <div class="exp-header">答案解析</div>
                <div class="exp-body">
                    <p><strong>正确答案：</strong>${q.answer}</p>
                    <p><strong>解析：</strong>${q.point || '无解析'}</p>
                    ${q.discuss ? `<p><strong>讨论：</strong>${q.discuss}</p>` : ''}
                </div>
            </div>`;

        // 拼接题目卡片HTML
        const questionHtml = `
            <div class="q-card" id="q-card">
                <div class="q-meta">
                    <span class="q-tag">单选题</span>
                    <span>题目 ${fileList.indexOf(currentFile) + 1}/${fileList.length}</span>
                </div>
                <div class="q-text">${q.test}</div>
                <ul class="q-options" id="q-options">${optionsHtml}</ul>
                <div class="multi-actions">
                    <button class="multi-check-btn" id="submit-answer">提交答案</button>
                    <button class="multi-check-btn" style="margin-left:10px;" id="collect-btn">${collectText}</button>
                </div>
                ${analysisHtml}
                <div id="next-btn-container" style="margin-top:20px; display:none;">
                    <button class="case-confirm-btn" id="next-btn">下一题</button>
                </div>
            </div>
        `;

        $('#question-content').html(questionHtml);

        // 绑定选项点击事件
        $('.q-option').click(function() {
            if ($('#q-options').hasClass('answered')) return; // 已提交则不可选
            // 取消其他选项选中状态
            $('.q-option').removeClass('selected-neutral');
            $('.q-option .radio-circle::after').css({ opacity: 0, transform: 'scale(0)' });
            // 设置当前选项选中
            $(this).addClass('selected-neutral');
            $(this).find('.radio-circle::after').css({ opacity: 1, transform: 'scale(1)' });
        });

        // 绑定右键排除选项事件
        $('.q-option').contextmenu(function(e) {
            e.preventDefault();
            const optIdx = parseInt($(this).data('opt-idx'));
            if (excludedOptions.includes(optIdx)) {
                excludedOptions = excludedOptions.filter(idx => idx !== optIdx);
                $(this).removeClass('option-excluded');
            } else { 
                excludedOptions.push(optIdx); 
                $(this).addClass('option-excluded'); 
            }
        });

        // 提交答案事件
        $('#submit-answer').click(() => checkAnswer(q));

        // 收藏事件
        $('#collect-btn').click(() => toggleCollect(q));
    };

    // 检查答案
    const checkAnswer = (q) => {
        const selectedOption = $('.q-option.selected-neutral');
        if (!selectedOption.length) return alert('请选择答案');
        
        const selectedKey = selectedOption.data('key');
        const isCorrect = selectedKey === q.answer;

        // 标记正确/错误选项
        $('.q-option').each(function() {
            const optKey = $(this).data('key');
            $(this).removeClass('selected-neutral');
            
            if (optKey === q.answer) {
                $(this).addClass('correct-answer');
            } else if (optKey === selectedKey && !isCorrect) {
                $(this).addClass('wrong-answer');
            }
        });

        // 标记已答题
        $('#q-options').addClass('answered');
        $('#q-card').addClass('answered');

        // 显示解析（考试模式）
        if (currentMode === 'exam') {
            const expClass = isCorrect ? 'correct' : 'wrong';
            const expHeader = isCorrect ? '回答正确 ✔' : '回答错误 ✘';
            const expBody = `
                <p><strong>正确答案：</strong>${q.answer}</p>
                <p><strong>你的答案：</strong>${selectedKey}</p>
                <p><strong>解析：</strong>${q.point || '无解析'}</p>
                ${q.discuss ? `<p><strong>讨论：</strong>${q.discuss}</p>` : ''}
            `;
            $('#analysis').removeClass('correct wrong').addClass(expClass);
            $('#analysis .exp-header').text(expHeader);
            $('#analysis .exp-body').html(expBody);
            $('#analysis').show();
        }

        // 记录完成状态
        if (!finished.includes(currentFile.name)) {
            finished.push(currentFile.name);
            localStorage.setItem(STORAGE_KEYS.finished, JSON.stringify(finished));
        }

        // 记录错题
        const isInWrong = wrongQuestions.some(w => w.filename === currentFile.name);
        if (!isCorrect && !isInWrong) {
            wrongQuestions.push({ filename: currentFile.name, ...q, userAnswer: selectedKey });
            localStorage.setItem(STORAGE_KEYS.wrong, JSON.stringify(wrongQuestions));
        }
        // 正确则移除错题
        if (isCorrect && isInWrong) {
            wrongQuestions = wrongQuestions.filter(w => w.filename !== currentFile.name);
            localStorage.setItem(STORAGE_KEYS.wrong, JSON.stringify(wrongQuestions));
        }

        // 刷新侧边栏和答题卡
        renderQuestionSidebar();
        refreshAnswerCard();

        // 显示下一题按钮
        const currentIdx = fileList.indexOf(currentFile);
        if (currentIdx < fileList.length - 1) {
            $('#next-btn-container').show();
            $('#next-btn').click(() => loadQuestion(currentIdx + 1));
        }
    };

    // 收藏/取消收藏
    const toggleCollect = (q) => {
        const idx = collected.findIndex(c => c.filename === currentFile.name);
        if (idx >= 0) {
            collected.splice(idx, 1);
            $('#collect-btn').text('收藏');
        } else {
            collected.push({ filename: currentFile.name, repo: currentRepoInfo.repo, path: currentRepoInfo.path, ...q });
            $('#collect-btn').text('取消收藏');
        }
        localStorage.setItem(STORAGE_KEYS.collected, JSON.stringify(collected));
        showMsg(idx >= 0 ? '取消收藏成功' : '收藏成功', false);
    };

    // 模式切换
    $('.mode-btn').click(function() {
        $('.mode-btn').removeClass('active');
        $(this).addClass('active');
        currentMode = $(this).data('mode');
        
        // 刷新当前题目
        if (currentFile) {
            const currentIdx = fileList.indexOf(currentFile);
            loadQuestion(currentIdx);
        }
    });

    // 导出错题本
    $('#export-wrong').click(function() {
        if (wrongQuestions.length === 0) return showMsg('暂无错题！', true);
        
        const wrongJson = JSON.stringify(wrongQuestions, null, 2);
        const blob = new Blob([wrongJson], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `医学刷题-错题本-${new Date().toLocaleDateString()}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        
        showMsg('错题本导出成功！', false);
    });

    // 收藏列表
    $('#show-collect').click(function() {
        const matchedCollects = collected.filter(isCollectMatchCurrentRepo);
        let html = '';
        
        if (matchedCollects.length === 0) {
            html = '<div style="padding:20px; text-align:center; color:#666;">暂无当前仓库的收藏题目</div>';
        } else {
            matchedCollects.forEach((item, i) => {
                html += `<div class="collect-item" data-i="${i}">
                    <strong>${i+1}.</strong> ${item.test.substring(0, 60)}...
                </div>`;
            });
        }
        
        $('#collect-items').html(html);
        toggleCollectModal(true);

        // 收藏项点击事件
        $('.collect-item').click(function() {
            const item = matchedCollects[$(this).data('i')];
            const file = fileList.find(f => f.name === item.filename);
            if (file) { 
                loadQuestion(fileList.indexOf(file));
                toggleCollectModal(false);
            }
        });
    });

    // 重置所有数据
    $('#reset-all').click(function() {
        if (confirm('确定重置所有进度、收藏、错题和缓存？')) {
            Object.keys(STORAGE_KEYS).forEach(key => localStorage.removeItem(STORAGE_KEYS[key]));
            collected = []; 
            finished = []; 
            wrongQuestions = []; 
            questionCache = {}; 
            excludedOptions = [];
            
            renderQuestionSidebar();
            refreshAnswerCard();
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>所有数据已重置，请重新选择题目</p></div>');
            
            showMsg('所有数据已重置！', false);
        }
    });

    // 侧边栏切换
    $('#load-config-btn, #question-list-btn').click(function() {
        $('.chapter-btn').removeClass('active');
        $(this).addClass('active');
        
        if ($(this).attr('id') === 'load-config-btn') {
            $('#github-config').show();
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><h2 style="margin-bottom: 20px;">请先配置并加载GitHub题库</h2><p>填写仓库信息后点击「加载题目列表」开始刷题。</p></div>');
        } else {
            $('#github-config').hide();
            if (fileList.length === 0) {
                $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>暂无题目，请先加载GitHub题库</p></div>');
            }
        }

        // 移动端自动关闭侧边栏
        if ($(window).width() <= 992) {
            $('#sidebar').removeClass('open');
        }
    });
});

// 侧边栏切换（移动端）
function toggleSidebar() {
    $('#sidebar').toggleClass('open');
}

// 答题卡弹窗切换
function toggleDashboard() {
    $('#dashboardModal').toggleClass('open');
    if ($('#dashboardModal').hasClass('open')) {
        $('#dashboardModal').css('display', 'flex');
    } else {
        $('#dashboardModal').css('display', 'none');
    }
}

// 打开答题卡
$(function() {
    $('#open-dashboard').click(function() {
        $('#dashboardModal').addClass('open').css('display', 'flex');
    });
});

// 收藏弹窗切换
function toggleCollectModal(show) {
    if (show === true) {
        $('#collectModal').addClass('open').css('display', 'flex');
    } else if (show === false) {
        $('#collectModal').removeClass('open').css('display', 'none');
    } else {
        $('#collectModal').toggleClass('open');
        if ($('#collectModal').hasClass('open')) {
            $('#collectModal').css('display', 'flex');
        } else {
            $('#collectModal').css('display', 'none');
        }
    }
}
</script>
</body>
</html>