<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åŒ»å­¦åˆ·é¢˜ - å®Œæ•´ç‰ˆ</title>
<link rel="stylesheet" href="TokyoNightStorm.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

<aside id="sidebar">
    <div class="sidebar-header">
        <h2>åŒ»å­¦åˆ·é¢˜ç³»ç»Ÿ</h2>
    </div>
    <ul class="chapter-list" id="chapterList">
        <li class="chapter-item">
            <button class="chapter-btn active" id="load-config-btn">é¢˜åº“é…ç½®</button>
        </li>
        <li class="chapter-item" id="question-list-item" style="display:none;">
            <button class="chapter-btn" id="question-list-btn">é¢˜ç›®åˆ—è¡¨</button>
            <ul class="section-list" id="question-section-list"></ul>
        </li>
    </ul>
</aside>

<button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>

<main id="app-main">
    <div id="contentArea" class="content-container">
        <!-- GitHub é…ç½®åŒº -->
        <div class="github-config" id="github-config">
            <h3>GitHub é¢˜åº“é…ç½®</h3>
            <p>ä»“åº“ï¼ˆå¦‚ï¼šuser/repoï¼‰ï¼š<input type="text" id="repo" placeholder="owner/repo" /></p>
            <p>Github Tokenï¼ˆå¯é€‰ï¼‰ï¼š<input type="password" id="token" /></p>
            <p>è·¯å¾„ï¼ˆå¯é€‰ï¼‰ï¼š<input type="text" id="path" placeholder="questions/" /></p>
            <button id="load-list">åŠ è½½é¢˜ç›®åˆ—è¡¨</button><br/><br/>
            <select id="styleSelector">
                <option value="Original.css">é»˜è®¤é£æ ¼</option>
                <option value="TokyoNightStorm.css">Tokyo Night Storm</option>
                <option value="ObsidianLite.css">Obsidian Lite</option>
                <option value="ObsidianDark.css">Obsidian Dark</option>
                <option value="TokyoNightStorm2.css">Tokyo Night Storm 2</option>
            </select>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel" id="stats-panel" style="display:none;">
            <h3>å­¦ä¹ ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">æ€»é¢˜æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completed-count">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="correct-count">0</div>
                    <div class="stat-label">ç­”å¯¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wrong-count">0</div>
                    <div class="stat-label">é”™é¢˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracy-rate">0%</div>
                    <div class="stat-label">æ­£ç¡®ç‡</div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½æŒ‰é’®åŒº -->
        <div class="func-buttons" id="func-buttons" style="display:none;">
            <button class="func-btn" id="show-collect">æˆ‘çš„æ”¶è—</button>
            <button class="func-btn" id="reset-all">é‡ç½®è¿›åº¦</button>
            <button class="func-btn" id="export-wrong">å¯¼å‡ºé”™é¢˜æœ¬</button>
            <button class="func-btn" id="open-dashboard">æ‰“å¼€ç­”é¢˜å¡</button>
            <button class="func-btn" id="random-question">éšæœºç»ƒä¹ </button>
            <button class="func-btn" id="review-wrong">éšæœºé”™é¢˜å›é¡¾</button>
        </div>

        <!-- æ¨¡å¼åˆ‡æ¢åŒº -->
        <div class="mode-controls" id="mode-controls" style="display:none;">
            <span>åˆ·é¢˜æ¨¡å¼ï¼š</span>
            <button class="mode-btn active" data-mode="recite">èƒŒé¢˜æ¨¡å¼</button>
            <button class="mode-btn" data-mode="instant">ç­”é¢˜æ¨¡å¼</button>
            <button class="mode-btn" data-mode="exam">è€ƒè¯•æ¨¡å¼</button>
        </div>
        <div id="msg" class="msg"></div>
        <!-- é¢˜ç›®å±•ç¤ºåŒº -->
        <div id="question-content" style="margin-top: 30px;">
            <div style="text-align: center; margin-top: 50px; color: #6c757d;">
                <h2 style="margin-bottom: 20px;">è¯·å…ˆé…ç½®å¹¶åŠ è½½GitHubé¢˜åº“</h2>
                <p>å¡«å†™ä»“åº“ä¿¡æ¯åç‚¹å‡»ã€ŒåŠ è½½é¢˜ç›®åˆ—è¡¨ã€å¼€å§‹åˆ·é¢˜ã€‚</p>
            </div>
        </div>
    </div>
</main>

<!-- ç­”é¢˜å¡å¼¹çª— -->
<div id="dashboardModal" class="dashboard-modal" onclick="if(event.target === this) toggleDashboard()">
    <div class="dashboard-content">
        <div class="dashboard-header">
            <span class="dashboard-title">é¢˜ç›®å¯¼èˆª (Question Dashboard)</span>
            <button class="dashboard-close" onclick="toggleDashboard()">&times;</button>
        </div>
        <div class="dashboard-legend">
            <div class="legend-item"><div class="dot correct"></div> æ­£ç¡®</div>
            <div class="legend-item"><div class="dot wrong"></div> é”™è¯¯</div>
            <div class="legend-item"><div class="dot answered"></div> å·²ç­”</div>
            <div class="legend-item"><div class="dot empty"></div> æœªç­”</div>
        </div>
        <div id="questionGrid" class="q-grid"></div>
    </div>
</div>

<!-- æ”¶è—å¼¹çª— -->
<div id="collectModal" class="collect-modal" onclick="if(event.target === this) toggleCollectModal()">
    <div class="collect-content">
        <div class="collect-header">
            <span class="collect-title">æˆ‘çš„æ”¶è—</span>
            <button class="collect-close" onclick="toggleCollectModal()">&times;</button>
        </div>
        <div id="collect-items" class="collect-items"></div>
    </div>
</div>

<script>
$(document).ready(function() {
    // åˆå§‹åŒ–ï¼šè·å–å½“å‰ä½¿ç”¨çš„CSSæ–‡ä»¶ï¼Œå¹¶è®¾ç½®ä¸‹æ‹‰æ¡†é»˜è®¤é€‰ä¸­é¡¹
    var currentStyle = $('link[href$=".css"]').attr('href') || 'Original.css';
    $('#styleSelector').val(currentStyle);

    // ç›‘å¬ä¸‹æ‹‰é€‰æ¡†çš„é€‰æ‹©å˜åŒ–äº‹ä»¶
    $('#styleSelector').change(function() {
        // è·å–é€‰ä¸­çš„æ–°æ ·å¼æ–‡ä»¶å
        var newStyle = $(this).val();
        // ä¿®æ”¹CSSé“¾æ¥çš„hrefå±æ€§ï¼Œåˆ‡æ¢æ ·å¼
        $('link[href$=".css"]').attr('href', newStyle);
        
        // å¯é€‰ï¼šæ·»åŠ æç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·æ ·å¼å·²åˆ‡æ¢
        console.log('æ ·å¼å·²åˆ‡æ¢ä¸ºï¼š', newStyle);
    });
});

$(function() {
    // å­˜å‚¨é”®å
    const STORAGE_KEYS = { 
        config: 'jq_github_config', 
        collected: 'jq_collected', 
        finished: 'jq_finished', 
        cache: 'jq_questions_cache', 
        wrong: 'jq_wrong_questions',
        correct: 'jq_correct_questions',
        history: 'jq_history'
    };

    // å…¨å±€çŠ¶æ€
    let fileList = [], questionCache = JSON.parse(localStorage.getItem(STORAGE_KEYS.cache) || '{}');
    let currentFile = null, currentMode = 'recite'; // é»˜è®¤èƒŒé¢˜æ¨¡å¼
    let collected = JSON.parse(localStorage.getItem(STORAGE_KEYS.collected) || '[]');
    let finished = JSON.parse(localStorage.getItem(STORAGE_KEYS.finished) || '[]');
    //let wrongQuestions = JSON.parse(localStorage.getItem(STORAGE_KEYS.wrong) || '[]'); // é”™é¢˜æœ¬
    //let correctQuestions = JSON.parse(localStorage.getItem(STORAGE_KEYS.correct) || '[]'); // æ­£ç¡®é¢˜æœ¬
    let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.history) || '[]'); // å†å²è®°å½•
    let excludedOptions = [], currentRepoInfo = { repo: '', path: '' };
    let currentIdx = -1;

    // å…ˆè¯»æœ¬åœ°é…ç½®
    let cfg = {};
    try {
    const stored = localStorage.getItem(STORAGE_KEYS.config);
    if (stored) cfg = JSON.parse(stored);
    } catch (e) {
    console.error("Parse config failed:", e);
    }

    // è¯»URLå‚æ•°å¹¶è¦†ç›–æœ¬åœ°é…ç½®
    const repo_from_url = new URLSearchParams(window.location.search).get('r');
    if (repo_from_url) {
    try {
        cfg.repo = repo_from_url || cfg.repo;
        
    } catch (e) {
        console.error("Decode URL param failed:", e);
    }
}
   
    const path_from_url = new URLSearchParams(window.location.search).get('p');
    if (path_from_url) {
    try {
        cfg.path = path_from_url || cfg.path;
    } catch (e) {
        console.error("Decode URL param failed:", e);
    }
} 

    // å¡«å……è¡¨å•å’Œå…¨å±€å˜é‡
    $('#repo').val(cfg.repo || '');
    $('#token').val(cfg.token || '');
    $('#path').val(cfg.path || '');
    currentRepoInfo.repo = cfg.repo || '';
    currentRepoInfo.path = (cfg.path || '').trim();

    // å·¥å…·å‡½æ•°
    const showMsg = (text, isError) => {
        $('#msg').text(text).removeClass('success error').addClass(isError ? 'error' : 'success').show();
        setTimeout(() => $('#msg').fadeOut(), 3000);
    };

    const getHeaders = () => {
        const headers = { 'Accept': 'application/vnd.github.v3+json' };
        if ($('#token').val()) headers['Authorization'] = `token ${$('#token').val()}`;
        return headers;
    };

    const saveConfig = () => {
        const configData = { repo: $('#repo').val(), token: $('#token').val(), path: $('#path').val() };
        localStorage.setItem(STORAGE_KEYS.config, JSON.stringify(configData));
        currentRepoInfo.repo = configData.repo; 
        currentRepoInfo.path = (configData.path || '').trim();
    };

    const saveCache = () => { 
        try { localStorage.setItem(STORAGE_KEYS.cache, JSON.stringify(questionCache)); } 
        catch (e) { console.error('ç¼“å­˜ä¿å­˜å¤±è´¥', e); } 
    };

    const updateStatsDisplay = () => {

        const currentRepoHistory = history.filter(h => h.repo === currentRepoInfo.repo && h.path === currentRepoInfo.path);
        console.log('Current Repo:', currentRepoInfo);
        const all = fileList.length;
        const total = currentRepoHistory.length;
        const correct = currentRepoHistory.filter(h => h.isCorrect && h.judged).length;
        const wrong = currentRepoHistory.filter(h => !h.isCorrect && h.judged).length;
        const accuracyRate = total > 0 ? Math.round((correct / total) * 100) : 0;
        
        $('#total-count').text(all);
        $('#completed-count').text(total);
        $('#correct-count').text(correct);
        $('#wrong-count').text(wrong);
        $('#accuracy-rate').text(`${accuracyRate}%`);
    };

    const isCollectMatchCurrentRepo = (item) => fileList.some(file => file.name === item.filename);

    // é¢„åŠ è½½é¢˜ç›®
    const preloadQuestions = async (currentIndex) => {
        const start = Math.max(0, currentIndex - 5);
        const end = Math.min(fileList.length - 1, currentIndex + 5);
        
        for (let i = start; i <= end; i++) {
            if (!questionCache[fileList[i].name]) {
                try {
                    const res = await fetch(fileList[i].apiUrl, { headers: getHeaders() });
                    if (!res.ok) continue;
                    
                    const fileData = await res.json();
                    const binaryStr = atob(fileData.content.replace(/\s+/g, ''));
                    const uint8Array = new Uint8Array(binaryStr.length);
                    for (let j = 0; j < binaryStr.length; j++) uint8Array[j] = binaryStr.charCodeAt(j);
                    const question = JSON.parse(new TextDecoder('utf-8').decode(uint8Array));
                    
                    questionCache[fileList[i].name] = question;
                } catch (err) {
                    console.error(`é¢„åŠ è½½é¢˜ç›®å¤±è´¥: ${fileList[i].name}`, err);
                }
            }
        }
        saveCache();
        renderQuestionSidebar();
    };

    // åˆ·æ–°ç­”é¢˜å¡
    const refreshAnswerCard = () => {
        if (fileList.length === 0) { 
            $('#questionGrid').html('<div style="text-align:center; padding:20px; color:#666;">æš‚æ— é¢˜ç›®</div>');
            return; 
        }
        let cardHtml = '';
        fileList.forEach((file, idx) => {

            const Newest_timestamp   //in History
                = history.filter(h => h.filename === file.name).map(h => new Date(h.timestamp)).sort((a, b) => b - a)[0]; 
            
            const isAnswered = history.some(h => h.filename === file.name && Newest_timestamp && new Date(h.timestamp).getTime() === Newest_timestamp.getTime() && h.judged === false);
            const isJudged = history.some(h => h.filename === file.name && Newest_timestamp && new Date(h.timestamp).getTime() === Newest_timestamp.getTime() && h.judged === true);
            const isCorrect = history.some(h => h.filename === file.name && Newest_timestamp && new Date(h.timestamp).getTime() === Newest_timestamp.getTime() && h.judged === true && h.isCorrect === true);


            let cardClass = 'q-grid-btn';
            if (isAnswered) {
                cardClass = 'q-grid-btn answered';
            } else if (isJudged && isCorrect) {
                cardClass = 'q-grid-btn correct';
            } else if (isJudged && !isCorrect) {
                cardClass = 'q-grid-btn wrong';
            } else {
                cardClass = 'q-grid-btn';
            }

            /*
            const isAnswered = finished.includes(file.name);
            const isWrong = wrongQuestions.some(w => w.filename === file.name);
            const isCorrect = correctQuestions.some(c => c.filename === file.name);
            let cardClass = 'q-grid-btn';
            if (isWrong) cardClass += ' wrong';
            else if (isAnswered && !isCorrect) cardClass += ' answered';
            else if (isCorrect) cardClass += ' correct';*/
            
            cardHtml += `<button class="${cardClass}" data-idx="${idx}">${idx+1}</button>`;
        });
        $('#questionGrid').html(cardHtml);
        // ç­”é¢˜å¡ç‚¹å‡»è·³è½¬
        $('.q-grid-btn').click(function() { 
            loadQuestion($(this).data('idx'));
            toggleDashboard(); // å…³é—­ç­”é¢˜å¡
        });
    };

    // åŠ è½½GitHubé¢˜ç›®åˆ—è¡¨
    $('#load-list').click(async function() {
        const repo = $('#repo').val();
        if (!repo || !repo.includes('/')) return showMsg('è¯·è¾“å…¥æ­£ç¡®çš„ä»“åº“æ ¼å¼ï¼šowner/repo', true);
        
        const [owner, name] = repo.split('/');
        const path = ($('#path').val() || '').trim();
        const apiUrl = `https://api.github.com/repos/${owner}/${name}/contents/${path}`;
        
        showMsg('å°‘å¥³ç¥ˆç¥·ä¸­â‹¯â‹¯', false);
        $(this).prop('disabled', true).html('<span class="loading-spinner"></span> å°‘å¥³ç¥ˆç¥·ä¸­â‹¯â‹¯');
        
        // è¯»å–repoå’Œpathçš„å†…å®¹
        Info=[repo,path];
        //Base64 Encode and log the Info object
        console.log('å½“å‰ä»“åº“ä¿¡æ¯ï¼š', Info);
        // url æ·»åŠ å‚æ•°i= base64ç¼–ç åçš„Infoå¯¹è±¡ï¼Œæ–¹ä¾¿è°ƒè¯•ä½¿ç”¨
        window.history.replaceState(null, '', `${window.location.pathname}?r=${repo}&p=${path}`);


        try {
            const res = await fetch(apiUrl, { headers: getHeaders() });
            if (!res.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼š${res.status}`);
            
            const items = await res.json();
            fileList = items.filter(item => item.type === 'file' && item.name.endsWith('.json'))
                            .map(item => ({ name: item.name, apiUrl: item.url }));

            if (fileList.length === 0) return showMsg('æœªæ‰¾åˆ°JSONé¢˜ç›®æ–‡ä»¶', true);
            saveConfig();
            // æ¸²æŸ“ä¾§è¾¹æ é¢˜ç›®åˆ—è¡¨
            renderQuestionSidebar();
            // æ˜¾ç¤ºåŠŸèƒ½æŒ‰é’®å’Œæ¨¡å¼åˆ‡æ¢
            //$('#func-buttons, #mode-controls, #stats-panel').show();
            $('#stats-panel').show();
            // æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨ä¾§è¾¹æ é¡¹
            $('#question-list-item').show();
            // åˆ·æ–°ç­”é¢˜å¡
            refreshAnswerCard();
            updateStatsDisplay();
            // æ¸…ç©ºé¢˜ç›®å±•ç¤ºåŒºé»˜è®¤æç¤º
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>è¯·ä»å·¦ä¾§èœå•é€‰æ‹©é¢˜ç›®å¼€å§‹åˆ·é¢˜</p></div>');
              
            showMsg(`åŠ è½½æˆåŠŸï¼š${fileList.length} ä¸ªé¢˜ç›®`, false);
        } catch (err) { 
            showMsg('åŠ è½½å¤±è´¥ï¼š' + err.message, true); 
        } finally {
            $(this).prop('disabled', false).text('åŠ è½½é¢˜ç›®åˆ—è¡¨');
        }
    });

    // æ¸²æŸ“ä¾§è¾¹æ é¢˜ç›®åˆ—è¡¨
    const renderQuestionSidebar = () => {
        let html = '';
        let currentIdx= fileList.indexOf(currentFile);
        fileList.forEach((file, idx) => {

            /*
            const isFinished = finished.includes(file.name);
            const isWrong = wrongQuestions.some(w => w.filename === file.name);
            const isCorrect = correctQuestions.some(c => c.filename === file.name);
            
            */

            const Newest_timestamp   //in History
                = history.filter(h => h.filename === file.name).map(h => new Date(h.timestamp)).sort((a, b) => b - a)[0]; 
            
            const isAnswered = history.some(h => h.filename === file.name && Newest_timestamp && new Date(h.timestamp).getTime() === Newest_timestamp.getTime() && h.judged === false);
            const isJudged = history.some(h => h.filename === file.name && Newest_timestamp && new Date(h.timestamp).getTime() === Newest_timestamp.getTime() && h.judged === true);
            const isCorrect = history.some(h => h.filename === file.name && Newest_timestamp && new Date(h.timestamp).getTime() === Newest_timestamp.getTime() && h.judged === true && h.isCorrect === true);

            const isCached = questionCache.hasOwnProperty(file.name);
            //const isCollected = collected.some(c => c.filename === file.name);
            const statusText = isJudged && !isCorrect ? '[âŒ]' : isJudged && isCorrect ? '[âœ…]' : '' + (isAnswered ? '[âœ”]' : '');
            const OtherstatusText = (isCached ? '' : 'ğŸ“¥') //+ (isCollected ? 'â­' : '');
            html += `<li><button class="section-btn ${idx === currentIdx ? 'active' : ''}" data-idx="${idx}">${idx + 1} ${statusText}${OtherstatusText}</button></li>`;
        });
        $('#question-section-list').html(html);
        
        // ä¾§è¾¹æ é¢˜ç›®ç‚¹å‡»äº‹ä»¶
        $('.section-btn').click(function() {
            $('#load-config-btn').removeClass('active');
            $('#question-list-btn').addClass('active');
            $('#func-buttons, #mode-controls').show();

            $('.section-btn').removeClass('active');
            $(this).addClass('active');
            loadQuestion($(this).data('idx'));
            $('#github-config, #stats-panel').hide();
            // ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
            if ($(window).width() <= 992) {
                $('#sidebar').removeClass('open');
            }
        });
    };

    // åŠ è½½å¹¶æ˜¾ç¤ºé¢˜ç›®
    const loadQuestion = async (idx) => {
        currentFile = fileList[idx]; 
        $('#question-content').html('<div style="text-align:center; padding:50px;"><p>å°‘å¥³ç¥ˆç¥·ä¸­â‹¯â‹¯</p></div>'); 
        excludedOptions = [];

        try {
            let question = questionCache[currentFile.name];
            if (!question) { // æ— ç¼“å­˜åˆ™ä»GitHubåŠ è½½
                const res = await fetch(currentFile.apiUrl, { headers: getHeaders() });
                if (!res.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼š${res.status}`);
                
                const fileData = await res.json();
                const binaryStr = atob(fileData.content.replace(/\s+/g, ''));
                const uint8Array = new Uint8Array(binaryStr.length);
                for (let i = 0; i < binaryStr.length; i++) uint8Array[i] = binaryStr.charCodeAt(i);
                question = JSON.parse(new TextDecoder('utf-8').decode(uint8Array));
                
                questionCache[currentFile.name] = question; 
                saveCache();
            }
            showQuestion(question); // æ¸²æŸ“é¢˜ç›®


            $('#next-btn').click(() => loadQuestion(Math.min(idx + 1, fileList.length - 1)));
            $('#prev-btn').click(() => loadQuestion(Math.max(idx - 1, 0)));
            $('#exam-submit-btn').off('click').click(() => submit_exam());
            // å¯åŠ¨é¢„åŠ è½½
            preloadQuestions(idx);
        } catch (err) { 
            $('#question-content').html(`<div style="color:var(--wrong-border); padding:20px;"><p>åŠ è½½å¤±è´¥ï¼š${err.message}</p></div>`); 
        }
    };

    // æ˜¾ç¤ºé¢˜ç›®ï¼ˆé€‚é…æ–°UIï¼ŒåŒºåˆ†èƒŒé¢˜/ç­”é¢˜æ¨¡å¼ï¼‰
    const showQuestion = (q) => {
        // æ„å»ºé€‰é¡¹HTML
        let optionsHtml = '';
        q.option.forEach((opt, optIdx) => {
            const key = opt.charAt(0);
            const isExcluded = excludedOptions.includes(optIdx);
            const optionClass = isExcluded ? 'option-excluded' : '';
            
            optionsHtml += `<li class="q-option ${optionClass}" data-opt-idx="${optIdx}" data-key="${key}">
                <span class="${q.answer.length<=1 ? 'radio-circle' : 'checkbox-square'}"></span>
                <span class="opt-text">${opt}</span>
            </li>`;
        });

        // æ”¶è—çŠ¶æ€
        const isCollected = collected.some(c => c.filename === currentFile.name);
        const collectText = isCollected ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—';

        // è§£æHTMLï¼ˆåŒºåˆ†æ¨¡å¼ï¼‰
        const analysisHtml = currentMode != 'recite' ? 
            '<div class="explanation" id="analysis"><div class="exp-header">ç­”æ¡ˆè§£æ</div><div class="exp-body"></div></div>' : 
            `<div class="explanation correct" id="analysis" style="display:block;">
                <div class="exp-header">ç­”æ¡ˆè§£æ</div>
                <div class="exp-body">
                    <p><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>${q.answer}</p>
                    <p><strong>è§£æï¼š</strong>${q.point || 'æ— è§£æ'}</p>
                    ${q.discuss ? `<p><strong>è®¨è®ºï¼š</strong>${q.discuss}</p>` : ''}
                </div>
            </div>`;

        // æ‹¼æ¥é¢˜ç›®å¡ç‰‡HTML
        const questionHtml = `<div class="q-card" id="q-card">
            <div class="q-meta">
                <span class="q-tag">${q.mode}</span>
                <span>é¢˜ç›® ${fileList.indexOf(currentFile) + 1}/${fileList.length}</span>
            </div><div class="q-text">${q.test}</div>
            <ul class="q-options" id="q-options">${optionsHtml}</ul>
            ${currentMode != 'recite' ? `
            <div class="multi-actions">
                <button class="multi-check-btn" id="submit-answer">æäº¤ç­”æ¡ˆ</button>
                <button class="multi-check-btn" style="margin-left:10px;" id="collect-btn">${collectText}</button>
                <button class="multi-check-btn" style="margin-left:10px;" id="clear-exclude">æ¸…ç©ºæ’é™¤</button>
            </div>` 
            
            : ''  // èƒŒé¢˜æ¨¡å¼ä¸æ˜¾ç¤ºæäº¤æŒ‰é’®
            }

                ${analysisHtml}
                <div id="next-btn-container" style="margin-top:20px;">
                <button class="case-confirm-btn" id="prev-btn">ä¸Šä¸€é¢˜</button>
                <button class="case-confirm-btn" id="next-btn">ä¸‹ä¸€é¢˜</button>
                <button class="case-confirm-btn" id="exam-submit-btn" style="${currentMode === 'exam' ? '' : 'display:none;'}">è€ƒè¯•äº¤å·</button>
            </div>
        </div>`;

        $('#question-content').html(questionHtml);

        // ç»‘å®šé€‰é¡¹ç‚¹å‡»äº‹ä»¶
        $('.q-option').click(function() {
            if ($('#q-options').hasClass('answered')) return; // å·²æäº¤åˆ™ä¸å¯é€‰

            // å¦‚æœæ˜¯radio-circleï¼Œå–æ¶ˆå…¶ä»–é€‰é¡¹é€‰ä¸­çŠ¶æ€
            if ($(this).find('.radio-circle').length > 0) {
                $('.q-option').removeClass('selected-neutral');
            }
            // å¦‚æœæ˜¯checkbox-squareï¼Œåˆ‡æ¢å½“å‰é€‰é¡¹é€‰ä¸­çŠ¶æ€
            else if ($(this).find('.checkbox-square').length > 0) {
                $(this).toggleClass('selected-neutral');
                return;
            }
            // è®¾ç½®å½“å‰é€‰é¡¹é€‰ä¸­
            $(this).addClass('selected-neutral');
        });

        // ç»‘å®šå³é”®æ’é™¤é€‰é¡¹äº‹ä»¶
        $('.q-option').contextmenu(function(e) {
            e.preventDefault();
            const optIdx = parseInt($(this).data('opt-idx'));
            if (excludedOptions.includes(optIdx)) {
                excludedOptions = excludedOptions.filter(idx => idx !== optIdx);
                $(this).removeClass('option-excluded');
            } else { 
                excludedOptions.push(optIdx); 
                $(this).addClass('option-excluded'); 
            }
        });

        // æäº¤ç­”æ¡ˆäº‹ä»¶
        $('#submit-answer').click(() => checkAnswer(q));

        // æ”¶è—äº‹ä»¶
        $('#collect-btn').click(() => toggleCollect(q));


        // æ¸…ç©ºæ’é™¤äº‹ä»¶
        $('#clear-exclude').click(() => {
            excludedOptions = [];
            $('.q-option').removeClass('option-excluded');
            showMsg('å·²æ¸…ç©ºæ’é™¤é€‰é¡¹', false);
        });
    };

    // æ£€æŸ¥ç­”æ¡ˆ
    const checkAnswer = (q) => {
        const selectedOption = $('.q-option.selected-neutral');
        const selectedKeytmp = [];
        selectedOption.each(function() {
            // å–å‡ºå½“å‰é€‰é¡¹çš„data-keyå€¼å¹¶åŠ å…¥æ•°ç»„
            selectedKeytmp.push($(this).data('key'));
        });
        const selectedKey = selectedKeytmp.sort().join('');
        
        console.log('Selected Key:', selectedKey);
        if (!selectedOption.length) return showMsg('è¯·é€‰æ‹©ç­”æ¡ˆ', true);
        const isCorrect = selectedKey === q.answer;

        // æ˜¾ç¤ºè§£æï¼ˆç­”é¢˜æ¨¡å¼ï¼‰
        if (currentMode === 'instant' ) {
        
            // æ ‡è®°æ­£ç¡®/é”™è¯¯é€‰é¡¹
            $('.q-option').each(function() {
                const optKey = $(this).data('key');
                $(this).removeClass('selected-neutral');
                
                if (optKey === q.answer) {
                    $(this).addClass('correct-answer');
                } else if (optKey === selectedKey && !isCorrect) {
                    $(this).addClass('wrong-answer');
                }
            });

            const expClass = isCorrect ? 'correct' : 'wrong';
            const expHeader = isCorrect ? 'å›ç­”æ­£ç¡® âœ”' : 'å›ç­”é”™è¯¯ âœ˜';
            const expBody = `
                <p><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>${q.answer}</p>
                <p><strong>ä½ çš„ç­”æ¡ˆï¼š</strong>${selectedKey}</p>
                <p><strong>è§£æï¼š</strong>${q.point || 'æ— è§£æ'}</p>
                ${q.discuss ? `<p><strong>è®¨è®ºï¼š</strong>${q.discuss}</p>` : ''}
            `;
            $('#analysis').removeClass('correct wrong').addClass(expClass);
            $('#analysis .exp-header').text(expHeader);
            $('#analysis .exp-body').html(expBody);
            $('#analysis').show();
        }
        // æ ‡è®°å·²ç­”é¢˜
        $('#q-options').addClass('answered');
        $('#q-card').addClass('answered');
        /*
        // è®°å½•å®ŒæˆçŠ¶æ€
        if (!finished.includes(currentFile.name) && false ) {
            finished.push(currentFile.name);
            localStorage.setItem(STORAGE_KEYS.finished, JSON.stringify(finished));
        }

        // è®°å½•æ­£ç¡®   
        const isInCorrect = correctQuestions.some(c => c.filename === currentFile.name);
        if (isCorrect) {
            correctQuestions.push({ filename: currentFile.name, repo: currentRepoInfo.repo, path: currentRepoInfo.path, ...q, userAnswer: selectedKey,timestamp: new Date().toISOString() });
            localStorage.setItem(STORAGE_KEYS.correct, JSON.stringify(correctQuestions));
        }

        // è®°å½•é”™é¢˜
        const isInWrong = wrongQuestions.some(w => w.filename === currentFile.name);
        if (!isCorrect) {
            wrongQuestions.push({ filename: currentFile.name, repo: currentRepoInfo.repo, path: currentRepoInfo.path, ...q, userAnswer: selectedKey ,timestamp: new Date().toISOString() });
            localStorage.setItem(STORAGE_KEYS.wrong, JSON.stringify(wrongQuestions));
        }
        // æ­£ç¡®åˆ™ç§»é™¤é”™é¢˜
        if (isCorrect && isInWrong) {
            wrongQuestions = wrongQuestions.filter(w => w.filename !== currentFile.name);
            localStorage.setItem(STORAGE_KEYS.wrong, JSON.stringify(wrongQuestions));
        }
        // é”™è¯¯åˆ™ç§»é™¤æ­£ç¡®é¢˜ç›®è®°å½•
        if (!isCorrect && isInCorrect) {
            correctQuestions = correctQuestions.filter(c => c.filename !== currentFile.name);
            localStorage.setItem(STORAGE_KEYS.correct, JSON.stringify(correctQuestions));
        }

        */
        // è®°å½•å†å²
        history.push({ filename: currentFile.name, repo: currentRepoInfo.repo, path: currentRepoInfo.path, ...q, userAnswer: selectedKey , isCorrect, timestamp: new Date().toISOString(), judged: currentMode === 'instant'? true : false });
        localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(history));
        updateStatsDisplay();

        // åˆ·æ–°ä¾§è¾¹æ å’Œç­”é¢˜å¡
        renderQuestionSidebar();
        refreshAnswerCard();

        // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
        const currentIdx = fileList.indexOf(currentFile);
        if (currentIdx < fileList.length - 1) {
            $('#next-btn-container').show();
        }
    };

    // æ”¶è—/å–æ¶ˆæ”¶è—
    const toggleCollect = (q) => {
        const idx = collected.findIndex(c => c.filename === currentFile.name);
        if (idx >= 0) {
            collected.splice(idx, 1);
            $('#collect-btn').text('æ”¶è—');
        } else {
            collected.push({ filename: currentFile.name, repo: currentRepoInfo.repo, path: currentRepoInfo.path, ...q });
            $('#collect-btn').text('å–æ¶ˆæ”¶è—');
        }
        localStorage.setItem(STORAGE_KEYS.collected, JSON.stringify(collected));
        showMsg(idx >= 0 ? 'å–æ¶ˆæ”¶è—æˆåŠŸ' : 'æ”¶è—æˆåŠŸ', false);
    };

    // æ¨¡å¼åˆ‡æ¢
    $('.mode-btn').click(function() {
        $('.mode-btn').removeClass('active');
        $(this).addClass('active');
        currentMode = $(this).data('mode');
        
        // åˆ·æ–°å½“å‰é¢˜ç›®
        if (currentFile) {
            const currentIdx = fileList.indexOf(currentFile);
            loadQuestion(currentIdx);
        }
    });

    const submit_exam = () => {
        if (confirm('ç¡®å®šäº¤å·å—ï¼Ÿ')) {
            // éå†æ‰€æœ‰é¢˜ç›®ï¼Œæäº¤æœªç­”é¢˜ç›®   isMatchCurrentRepo
            for (let i = 0; i < history.length; i++) {
                if(history[i].repo === currentRepoInfo.repo && 
                   history[i].path === currentRepoInfo.path &&
                   history[i].judged === false) {
                    history[i].judged = true;
                }
            }
            // æ›´æ–°å†å²è®°å½•
            try { localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(history)); } 
            catch (e) { console.error('ç¼“å­˜ä¿å­˜å¤±è´¥', e); } 
            showMsg('è€ƒè¯•å·²æäº¤ï¼', false);
            // åˆ·æ–°å½“å‰é¢˜ç›®
            refreshAnswerCard();
            updateStatsDisplay();
            renderQuestionSidebar();
        }
    };


    // å¯¼å‡ºé”™é¢˜æœ¬
    $('#export-wrong').click(function() {
        if (wrongQuestions.length === 0) return showMsg('æš‚æ— é”™é¢˜ï¼', true);
        
        const wrongJson = JSON.stringify(wrongQuestions, null, 2);
        const blob = new Blob([wrongJson], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `åŒ»å­¦åˆ·é¢˜-é”™é¢˜æœ¬-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        
        showMsg('é”™é¢˜æœ¬å¯¼å‡ºæˆåŠŸï¼', false);
    });

    // æ”¶è—åˆ—è¡¨
    $('#show-collect').click(function() {
        const matchedCollects = collected.filter(isCollectMatchCurrentRepo);
        let html = '';
        
        if (matchedCollects.length === 0) {
            html = '<div style="padding:20px; text-align:center; color:#666;">æš‚æ— å½“å‰ä»“åº“çš„æ”¶è—é¢˜ç›®</div>';
        } else {
            matchedCollects.forEach((item, i) => {
                html += `<div class="collect-item" data-i="${i}">
                    <strong>${i+1}.</strong> ${item.test.substring(0, 60)}...
                </div>`;
            });
        }
        
        $('#collect-items').html(html);
        toggleCollectModal(true);

        // æ”¶è—é¡¹ç‚¹å‡»äº‹ä»¶
        $('.collect-item').click(function() {
            const item = matchedCollects[$(this).data('i')];
            const file = fileList.find(f => f.name === item.filename);
            if (file) { 
                loadQuestion(fileList.indexOf(file));
                toggleCollectModal(false);
            }
        });
    });

    // éšæœºç»ƒä¹ 
    $('#random-question').click(function() {
        if (fileList.length === 0) {
            showMsg('è¯·å…ˆåŠ è½½é¢˜ç›®', true);
            return;
        }
        const randomIdx = Math.floor(Math.random() * fileList.length);
        loadQuestion(randomIdx);
    });

    // é”™é¢˜å›é¡¾
    $('#review-wrong').click(function() {
        if (wrongQuestions.length === 0) {
            showMsg('æš‚æ— é”™é¢˜', true);
            return;
        }
        // è¿‡æ»¤å‡ºå½“å‰ä»“åº“çš„é”™é¢˜
        const currentRepoWrong = wrongQuestions.filter(w => 
            w.repo === currentRepoInfo.repo && 
            w.path === currentRepoInfo.path
        );
        
        if (currentRepoWrong.length === 0) {
            showMsg('å½“å‰ä»“åº“æš‚æ— é”™é¢˜', true);
            return;
        }
        
        // éšæœºé€‰æ‹©ä¸€é“é”™é¢˜
        const randomWrong = currentRepoWrong[Math.floor(Math.random() * currentRepoWrong.length)];
        const file = fileList.find(f => f.name === randomWrong.filename);
        
        if (file) {
            loadQuestion(fileList.indexOf(file));
        } else {
            showMsg('é¢˜ç›®ä¸å­˜åœ¨', true);
        }
    });

    // é‡ç½®æ‰€æœ‰æ•°æ®
    $('#reset-all').click(function() {
        if (confirm('ç¡®å®šé‡ç½®æ‰€æœ‰è¿›åº¦ã€æ”¶è—ã€é”™é¢˜å’Œç¼“å­˜ï¼Ÿ')) {
            Object.keys(STORAGE_KEYS).forEach(key => localStorage.removeItem(STORAGE_KEYS[key]));
            collected = []; 
            finished = []; 
            //wrongQuestions = []; 
            questionCache = {}; 
            excludedOptions = [];
            
            renderQuestionSidebar();
            refreshAnswerCard();
            updateStatsDisplay();
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼Œè¯·é‡æ–°é€‰æ‹©é¢˜ç›®</p></div>');
            
            showMsg('æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼', false);
        }
    });

    // ä¾§è¾¹æ åˆ‡æ¢
    $('#load-config-btn, #question-list-btn').click(function() {
        $('.chapter-btn').removeClass('active');
        $(this).addClass('active');
        
        if ($(this).attr('id') === 'load-config-btn') {
            $('#github-config, #stats-panel').show();
            $('#func-buttons, #mode-controls').hide();
            $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><h2 style="margin-bottom: 20px;">è¯·å…ˆé…ç½®å¹¶åŠ è½½GitHubé¢˜åº“</h2><p>å¡«å†™ä»“åº“ä¿¡æ¯åç‚¹å‡»ã€ŒåŠ è½½é¢˜ç›®åˆ—è¡¨ã€å¼€å§‹åˆ·é¢˜ã€‚</p></div>');
        } else {
            $('#github-config, #stats-panel').hide();
            $('#func-buttons, #mode-controls').show();
            if (fileList.length === 0) {
                $('#question-content').html('<div style="text-align: center; margin-top: 50px; color: #6c757d;"><p>æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆåŠ è½½GitHubé¢˜åº“</p></div>');
            }
        }

        // ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
        if ($(window).width() <= 992) {
            $('#sidebar').removeClass('open');
        }
    });
    
    // åˆå§‹åŒ–ç»Ÿè®¡æ˜¾ç¤º
    updateStatsDisplay();
});

// ä¾§è¾¹æ åˆ‡æ¢ï¼ˆç§»åŠ¨ç«¯ï¼‰
function toggleSidebar() {
    $('#sidebar').toggleClass('open');
}

// ç­”é¢˜å¡å¼¹çª—åˆ‡æ¢
function toggleDashboard() {
    $('#dashboardModal').toggleClass('open');
    if ($('#dashboardModal').hasClass('open')) {
        $('#dashboardModal').css('display', 'flex');
    } else {
        $('#dashboardModal').css('display', 'none');
    }
}

// æ‰“å¼€ç­”é¢˜å¡
$(function() {
    $('#open-dashboard').click(function() {
        $('#dashboardModal').addClass('open').css('display', 'flex');
    });
});

// æ”¶è—å¼¹çª—åˆ‡æ¢
function toggleCollectModal(show) {
    if (show === true) {
        $('#collectModal').addClass('open').css('display', 'flex');
    } else if (show === false) {
        $('#collectModal').removeClass('open').css('display', 'none');
    } else {
        $('#collectModal').toggleClass('open');
        if ($('#collectModal').hasClass('open')) {
            $('#collectModal').css('display', 'flex');
        } else {
            $('#collectModal').css('display', 'none');
        }
    }
}
</script>
</body>
</html>



