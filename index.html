<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>医学刷题 - 极简版</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    /* 仅添加必要的排除样式，保持极简 */
    .option-excluded {
      color: #999;
      text-decoration: line-through;
      cursor: not-allowed;
    }
    .option-excluded input {
      pointer-events: none;
      opacity: 0.5;
    }
  </style>
</head>
<body>

<!-- GitHub 配置区 -->
<div id="github-config">
  <h3>GitHub 题库配置</h3>
  <p>仓库（如：user/repo）：<input type="text" id="repo" placeholder="owner/repo" /></p>
  <p>Token（私有仓库需要）：<input type="password" id="token" /></p>
  <p>路径（可选）：<input type="text" id="path" placeholder="questions/" /></p>
  <button id="load-list">加载题目列表</button>
  <div id="msg"></div>
</div>

<!-- 主界面（题库加载后显示） -->
<div id="main" style="display:none;">
  <h2>医学在线刷题</h2>
  <button id="show-collect">我的收藏</button>
  <button id="reset-all">重置进度</button>

  <div id="question-list">
    <h4>题目列表</h4>
    <div id="list-items"></div>
  </div>

  <div id="current-question">
    <div id="question-content">请选择一道题目开始答题</div>
  </div>
</div>

<!-- 收藏弹窗 -->
<div id="collect-modal" style="display:none;">
  <h3>我的收藏</h3>
  <div id="collect-items"></div>
  <button id="close-collect">关闭</button>
</div>

<script>
$(function() {
  // 存储键名
  const STORAGE_KEYS = {
    config: 'jq_github_config',
    collected: 'jq_collected',
    finished: 'jq_finished',
    cache: 'jq_questions_cache'
  };

  // 全局变量
  let fileList = [];       
  let questionCache = JSON.parse(localStorage.getItem(STORAGE_KEYS.cache) || '{}');
  let currentFile = null;
  let collected = JSON.parse(localStorage.getItem(STORAGE_KEYS.collected) || '[]');
  let finished = JSON.parse(localStorage.getItem(STORAGE_KEYS.finished) || '[]');
  let excludedOptions = [];
  // 新增：存储当前加载的仓库和路径信息
  let currentRepoInfo = {
    repo: '',
    path: ''
  };

  // 初始化：加载配置
  const cfg = JSON.parse(localStorage.getItem(STORAGE_KEYS.config) || '{}');
  $('#repo').val(cfg.repo || '');
  $('#token').val(cfg.token || '');
  $('#path').val(cfg.path || '');
  currentRepoInfo.repo = cfg.repo || '';
  currentRepoInfo.path = (cfg.path || '').trim();

  // 工具函数
  const showMsg = (text, isError) => $('#msg').text(text).css('color', isError ? 'red' : 'black');
  const getHeaders = () => {
    const headers = { 'Accept': 'application/vnd.github.v3+json' };
    const token = $('#token').val();
    if (token) headers['Authorization'] = `token ${token}`;
    return headers;
  };

  // 保存配置
  const saveConfig = () => {
    const configData = {
      repo: $('#repo').val(),
      token: $('#token').val(),
      path: $('#path').val()
    };
    localStorage.setItem(STORAGE_KEYS.config, JSON.stringify(configData));
    // 更新当前仓库路径信息
    currentRepoInfo.repo = configData.repo;
    currentRepoInfo.path = (configData.path || '').trim();
  };

  // 保存缓存
  const saveCache = () => {
    try {
      localStorage.setItem(STORAGE_KEYS.cache, JSON.stringify(questionCache));
    } catch (e) {
      console.error('缓存保存失败', e);
    }
  };

  // 新增：校验收藏题目是否属于当前仓库和路径
  const isCollectMatchCurrentRepo = (collectItem) => {
    // 如果还没加载任何仓库，不显示收藏
    if (!currentRepoInfo.repo) return false;
    
    // 查找该收藏题目是否在当前加载的文件列表中
    const isInCurrentFileList = fileList.some(file => file.name === collectItem.filename);
    return isInCurrentFileList;
  };

  // 加载题目列表
  $('#load-list').click(async function() {
    const repo = $('#repo').val();
    if (!repo || !repo.includes('/')) return showMsg('请输入正确的仓库格式：owner/repo', true);

    const [owner, name] = repo.split('/');
    const path = ($('#path').val() || '').trim();
    const apiUrl = `https://api.github.com/repos/${owner}/${name}/contents/${path}`;

    // 更新当前仓库路径信息
    currentRepoInfo.repo = repo;
    currentRepoInfo.path = path;

    showMsg('加载中...');
    try {
      const res = await fetch(apiUrl, { headers: getHeaders() });
      if (!res.ok) throw new Error(`请求失败：${res.status}`);
      
      const items = await res.json();
      fileList = items.filter(item => item.type === 'file' && item.name.endsWith('.json'))
                      .map(item => ({ name: item.name, apiUrl: item.url }));

      if (fileList.length === 0) return showMsg('未找到JSON题目文件', true);
      
      renderList();
      $('#main').show();
      saveConfig();
      showMsg(`加载成功：${fileList.length} 个题目`);
    } catch (err) {
      showMsg('加载失败：' + err.message, true);
    }
  });

  // 渲染题目列表
  const renderList = () => {
    let html = '';
    fileList.forEach((file, idx) => {
      html += `<div class="q-item" data-idx="${idx}">${idx + 1}. ${file.name}</div>`;
    });
    $('#list-items').html(html).find('.q-item').click(function() {
      loadQuestion($(this).data('idx'));
    });
  };

  // 加载并显示题目
  const loadQuestion = async (idx) => {
    currentFile = fileList[idx];
    $('#question-content').text('加载中...');
    excludedOptions = [];

    try {
      // 优先使用缓存
      let question = questionCache[currentFile.name];
      if (!question) {
        const res = await fetch(currentFile.apiUrl, { headers: getHeaders() });
        if (!res.ok) throw new Error(`请求失败：${res.status}`);
        
        const fileData = await res.json();
        // 解析Base64内容
        const binaryStr = atob(fileData.content.replace(/\s+/g, ''));
        const uint8Array = new Uint8Array(binaryStr.length);
        for (let i = 0; i < binaryStr.length; i++) {
          uint8Array[i] = binaryStr.charCodeAt(i);
        }
        question = JSON.parse(new TextDecoder('utf-8').decode(uint8Array));
        
        // 存入缓存
        questionCache[currentFile.name] = question;
        saveCache();
      }

      // 显示题目
      showQuestion(question);
    } catch (err) {
      $('#question-content').text('加载失败：' + err.message);
    }
  };

  // 显示题目内容
  const showQuestion = (q) => {
    let options = '';
    q.option.forEach((opt, optIdx) => {
      const key = opt.charAt(0);
      const isExcluded = excludedOptions.includes(optIdx);
      const optionClass = isExcluded ? 'option-excluded' : '';
      options += `<label class="option-item ${optionClass}" data-opt-idx="${optIdx}">
        <input type="radio" name="answer" value="${key}"> ${opt}
      </label><br>`;
    });

    const isCollected = collected.some(c => c.filename === currentFile.name);
    $('#question-content').html(`
      <h3>${q.test}</h3>
      <div id="options-container">${options}</div>
      <button id="submit">提交答案</button>
      <button id="collect">${isCollected ? '取消收藏' : '收藏'}</button>
      <div id="result"></div>
      <div id="analysis" style="display:none;">
        <p><strong>解析：</strong>${q.point || ''}</p>
        ${q.discuss ? `<p><strong>讨论：</strong>${q.discuss}</p>` : ''}
      </div>
    `);

    // 绑定选项右键排除功能
    $('.option-item').contextmenu(function(e) {
      e.preventDefault(); // 阻止默认右键菜单
      const optIdx = parseInt($(this).data('opt-idx'));
      const $this = $(this);
      
      // 切换排除状态
      if (excludedOptions.includes(optIdx)) {
        // 恢复选项
        excludedOptions = excludedOptions.filter(idx => idx !== optIdx);
        $this.removeClass('option-excluded');
      } else {
        // 排除选项
        excludedOptions.push(optIdx);
        $this.addClass('option-excluded');
      }
    });

    // 绑定原有事件
    $('#submit').click(() => checkAnswer(q));
    $('#collect').click(() => toggleCollect(q));
  };

  // 提交并检查答案
  const checkAnswer = (q) => {
    const selected = $('input[name="answer"]:checked').val();
    if (!selected) return alert('请选择答案');

    const isCorrect = selected === q.answer;
    $('#result').text(`${isCorrect ? '回答正确！' : '回答错误！'} 正确答案：${q.answer}`);
    $('#analysis').show();

    // 记录完成状态
    if (!finished.includes(currentFile.name)) {
      finished.push(currentFile.name);
      localStorage.setItem(STORAGE_KEYS.finished, JSON.stringify(finished));
    }

    // 下一题按钮
    const currentIdx = fileList.indexOf(currentFile);
    if (currentIdx < fileList.length - 1) {
      $('#question-content').append('<button id="next">下一题</button>');
      $('#next').click(() => loadQuestion(currentIdx + 1));
    }
  };

  // 收藏/取消收藏
  const toggleCollect = (q) => {
    const idx = collected.findIndex(c => c.filename === currentFile.name);
    if (idx >= 0) {
      collected.splice(idx, 1);
    } else {
      // 收藏时记录当前仓库和路径信息
      collected.push({ 
        filename: currentFile.name, 
        repo: currentRepoInfo.repo,
        path: currentRepoInfo.path,
        ...q 
      });
    }
    localStorage.setItem(STORAGE_KEYS.collected, JSON.stringify(collected));
    $('#collect').text(idx >= 0 ? '收藏' : '取消收藏');
  };

  // 收藏列表（新增匹配校验）
  $('#show-collect').click(function() {
    // 过滤出属于当前仓库和路径的收藏题目
    const matchedCollects = collected.filter(isCollectMatchCurrentRepo);
    let html = '';
    
    if (matchedCollects.length === 0) {
      html = '<p>暂无当前仓库的收藏题目</p>';
    } else {
      matchedCollects.forEach((item, i) => {
        html += `<div class="collect-item" data-i="${i}">${item.test.substring(0, 50)}...</div>`;
      });
    }
    
    $('#collect-items').html(html);
    $('#collect-modal').show();

    $('.collect-item').click(function() {
      const i = $(this).data('i');
      const item = matchedCollects[i]; // 注意：使用过滤后的列表
      const file = fileList.find(f => f.name === item.filename);
      if (file) {
        loadQuestion(fileList.indexOf(file));
        $('#collect-modal').hide();
      }
    });
  });

  $('#close-collect').click(() => $('#collect-modal').hide());

  // 重置所有数据
  $('#reset-all').click(function() {
    if (confirm('确定重置所有进度、收藏和缓存？')) {
      localStorage.removeItem(STORAGE_KEYS.finished);
      localStorage.removeItem(STORAGE_KEYS.collected);
      localStorage.removeItem(STORAGE_KEYS.cache);
      collected = [];
      finished = [];
      questionCache = {};
      excludedOptions = [];
      renderList();
      $('#question-content').text('请选择一道题目开始答题');
    }
  });
});
</script>

</body>
</html>