<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åŒ»å­¦åˆ·é¢˜ - è½»é‡ç‰ˆ</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

<!-- GitHub é…ç½®åŒº -->
<div id="github-config">
  <h3>GitHub é¢˜åº“é…ç½®</h3>
  <p>ä»“åº“ï¼ˆå¦‚ï¼šuser/repoï¼‰ï¼š<input type="text" id="repo" placeholder="owner/repo" /></p>
  <p>Tokenï¼ˆç§æœ‰ä»“åº“éœ€è¦ï¼‰ï¼š<input type="password" id="token" /></p>
  <p>è·¯å¾„ï¼ˆå¯é€‰ï¼‰ï¼š<input type="text" id="path" placeholder="questions/" /></p>
  <button id="load-list">åŠ è½½é¢˜ç›®åˆ—è¡¨</button>
  <div id="msg"></div>
</div>

<!-- ä¸»ç•Œé¢ï¼ˆé¢˜åº“åŠ è½½åæ˜¾ç¤ºï¼‰ -->
<div id="main" style="display:none;">
  <h2>åŒ»å­¦åœ¨çº¿åˆ·é¢˜</h2>
  <button id="show-collect">æˆ‘çš„æ”¶è—</button>
  <button id="reset-all">é‡ç½®è¿›åº¦</button>

  <div id="nav">
    <h4>åˆ†ç±»</h4>
    <div id="categories"></div>
  </div>

  <div id="question-list">
    <h4>é¢˜ç›®åˆ—è¡¨ï¼ˆä»…æ–‡ä»¶åï¼‰</h4>
    <div id="list-items"></div>
  </div>

  <div id="current-question" style="margin-top:20px; padding:10px; border:1px solid #ccc;">
    <div id="question-content">è¯·é€‰æ‹©ä¸€é“é¢˜ç›®å¼€å§‹ç­”é¢˜</div>
    <div id="preload-status" style="margin-top:10px; font-size:12px; color:#666;"></div>
  </div>
</div>

<!-- æ”¶è—å¼¹çª—ï¼ˆç®€å• div æ¨¡æ‹Ÿï¼‰ -->
<div id="collect-modal" style="display:none; position:fixed; top:20%; left:20%; width:60%; background:#fff; border:2px solid #000; padding:20px; z-index:1000;">
  <h3>æˆ‘çš„æ”¶è—</h3>
  <div id="collect-items"></div>
  <br><button id="close-collect">å…³é—­</button>
</div>

<script>
$(function() {
  // ====== é…ç½® & çŠ¶æ€ ======
  const STORAGE = {
    config: 'jq_github_config',
    progress: 'jq_progress',
    collected: 'jq_collected',
    finished: 'jq_finished',
    questionsCache: 'jq_questions_cache' // æ–°å¢ï¼šå­˜å‚¨é¢˜ç›®ç¼“å­˜çš„key
  };

  let fileList = [];       // å­˜å‚¨ {name, path, apiUrl} çš„æ–‡ä»¶åˆ—è¡¨
  let questionsCache = {}; // å†…å­˜ç¼“å­˜ï¼Œä¼˜å…ˆè¯»å–
  let currentFile = null;
  let collected = JSON.parse(localStorage.getItem(STORAGE.collected) || '[]');
  let finished = JSON.parse(localStorage.getItem(STORAGE.finished) || '[]');
  let preloadPromise = null; // é¢„åŠ è½½Promiseï¼Œé˜²æ­¢é‡å¤é¢„åŠ è½½

  // ====== åˆå§‹åŒ–ç¼“å­˜ï¼šä»æœ¬åœ°å­˜å‚¨åŠ è½½ ======
  function initQuestionsCache() {
    const cached = localStorage.getItem(STORAGE.questionsCache);
    if (cached) {
      try {
        questionsCache = JSON.parse(cached);
      } catch (e) {
        console.error('åŠ è½½æœ¬åœ°ç¼“å­˜å¤±è´¥ï¼Œå°†æ¸…ç©ºç¼“å­˜', e);
        questionsCache = {};
        localStorage.removeItem(STORAGE.questionsCache);
      }
    }
  }

  // ====== ä¿å­˜ç¼“å­˜åˆ°æœ¬åœ°å­˜å‚¨ ======
  function saveQuestionsCache() {
    try {
      localStorage.setItem(STORAGE.questionsCache, JSON.stringify(questionsCache));
    } catch (e) {
      console.error('ä¿å­˜ç¼“å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥', e);
      // æœ¬åœ°å­˜å‚¨æ»¡äº†çš„è¯ï¼Œæ¸…ç©ºæœ€æ—§çš„ç¼“å­˜ï¼ˆç®€å•å¤„ç†ï¼‰
      const keys = Object.keys(questionsCache);
      if (keys.length > 0) {
        delete questionsCache[keys[0]];
        saveQuestionsCache();
      }
    }
  }

  // ====== å·¥å…·å‡½æ•° ======
  function saveConfig() {
    localStorage.setItem(STORAGE.config, JSON.stringify({
      repo: $('#repo').val(),
      token: $('#token').val(),
      path: $('#path').val()
    }));
  }

  function loadConfig() {
    const cfg = JSON.parse(localStorage.getItem(STORAGE.config) || '{}');
    $('#repo').val(cfg.repo || '');
    $('#token').val(cfg.token || '');
    $('#path').val(cfg.path || '');
  }

  function showMessage(text, isError = false) {
    $('#msg').html(`<p style="color:${isError ? 'red' : 'green'};">${text}</p>`);
  }

  function getHeaders() {
    const token = $('#token').val();
    const headers = { 
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    };
    if (token) headers['Authorization'] = `token ${token}`;
    return headers;
  }

  // ====== ä» GitHub è·å– .json æ–‡ä»¶åˆ—è¡¨ ======
  $('#load-list').on('click', async function() {
    const repo = $('#repo').val();
    if (!repo || !repo.includes('/')) {
      showMessage('è¯·è¾“å…¥æ­£ç¡®çš„ä»“åº“æ ¼å¼ï¼šowner/repo', true);
      return;
    }

    const [owner, name] = repo.split('/');
    const path = ($('#path').val() || '').trim();
    const apiUrl = `https://api.github.com/repos/${owner}/${name}/contents/${path}`;

    $('#msg').text('æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...');
    try {
      const res = await fetch(apiUrl, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
      
      const items = await res.json();
      fileList = items
        .filter(item => item.type === 'file' && item.name.endsWith('.json'))
        .map(item => ({ 
          name: item.name, 
          path: item.path,
          apiUrl: item.url
        }));

      if (fileList.length === 0) {
        showMessage('æœªæ‰¾åˆ° .json é¢˜ç›®æ–‡ä»¶', true);
        return;
      }

      // åˆå§‹åŒ–ç¼“å­˜
      initQuestionsCache();
      
      renderQuestionList();
      $('#main').show();
      saveConfig();
      showMessage(`æˆåŠŸåŠ è½½ ${fileList.length} ä¸ªé¢˜ç›®æ–‡ä»¶`, false);
    } catch (err) {
      console.error(err);
      showMessage('åŠ è½½å¤±è´¥ï¼š' + err.message, true);
    }
  });

  // ====== æ¸²æŸ“é¢˜ç›®åˆ—è¡¨ ======
  function renderQuestionList() {
    let html = '';
    fileList.forEach((file, idx) => {
      const isCollected = collected.some(c => c.filename === file.name);
      const isFinished = finished.includes(file.name);
      const isCached = !!questionsCache[file.name]; // æ ‡è®°æ˜¯å¦å·²ç¼“å­˜
      html += `
        <div class="q-item" data-idx="${idx}" style="padding:5px; cursor:pointer; border-bottom:1px solid #eee;">
          ${idx + 1}. ${file.name}
          ${isCollected ? ' â­' : ''}
          ${isFinished ? ' âœ…' : ''}
          ${isCached ? ' ğŸ“¥' : ''} <!-- ç¼“å­˜æ ‡è®° -->
        </div>
      `;
    });
    $('#list-items').html(html);

    $('.q-item').on('click', function() {
      const idx = $(this).data('idx');
      loadAndShowQuestion(idx);
    });
  }

  // ====== åŠ è½½å•ä¸ªé¢˜ç›®ï¼ˆæ”¯æŒæœ¬åœ°ç¼“å­˜ï¼‰ ======
  async function loadSingleQuestion(file) {
    // å†…å­˜ç¼“å­˜ä¼˜å…ˆ
    if (questionsCache[file.name]) {
      return questionsCache[file.name];
    }

    try {
      const res = await fetch(file.apiUrl, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
      
      const fileData = await res.json();
      // æ¸…ç†Base64ä¸­çš„æ‰€æœ‰æ¢è¡Œ/ç©ºæ ¼ï¼Œè§£å†³ä¸­æ–‡ä¹±ç 
      const cleanBase64 = fileData.content.replace(/\s+/g, '');
      const binaryStr = atob(cleanBase64);
      const uint8Array = new Uint8Array(binaryStr.length);
      for (let i = 0; i < binaryStr.length; i++) {
        uint8Array[i] = binaryStr.charCodeAt(i);
      }
      const jsonStr = new TextDecoder('utf-8').decode(uint8Array);
      const question = JSON.parse(jsonStr);
      
      // å­˜å…¥å†…å­˜ç¼“å­˜å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      questionsCache[file.name] = question;
      saveQuestionsCache();
      
      return question;
    } catch (err) {
      console.error(`åŠ è½½é¢˜ç›® ${file.name} å¤±è´¥ï¼š`, err);
      throw err;
    }
  }

  // ====== é¢„åŠ è½½å‰å4é¢˜ ======
  async function preloadSurroundingQuestions(currentIdx) {
    if (preloadPromise) return preloadPromise; // é˜²æ­¢é‡å¤é¢„åŠ è½½
    if (fileList.length === 0) return;

    // è®¡ç®—é¢„åŠ è½½èŒƒå›´ï¼šå‰å4é¢˜ï¼Œè¾¹ç•Œå¤„ç†
    const startIdx = Math.max(0, currentIdx - 4);
    const endIdx = Math.min(fileList.length - 1, currentIdx + 4);
    const preloadFiles = fileList.slice(startIdx, endIdx + 1)
      .filter(file => !questionsCache[file.name]); // åªåŠ è½½æœªç¼“å­˜çš„

    if (preloadFiles.length === 0) {
      $('#preload-status').text('âœ… å‰åé¢˜ç›®å·²å…¨éƒ¨ç¼“å­˜');
      preloadPromise = null;
      return;
    }

    // æ˜¾ç¤ºé¢„åŠ è½½çŠ¶æ€
    $('#preload-status').text(`ğŸ”„ é¢„åŠ è½½ä¸­ï¼š${preloadFiles.length} é“é¢˜ç›®`);
    
    preloadPromise = Promise.all(
      preloadFiles.map(file => loadSingleQuestion(file).catch(err => console.error(`é¢„åŠ è½½ ${file.name} å¤±è´¥ï¼š`, err)))
    );

    try {
      await preloadPromise;
      $('#preload-status').text(`âœ… é¢„åŠ è½½å®Œæˆï¼šå·²ç¼“å­˜ ${Object.keys(questionsCache).length}/${fileList.length} é“é¢˜ç›®`);
      renderQuestionList(); // æ›´æ–°ç¼“å­˜æ ‡è®°
    } catch (err) {
      $('#preload-status').text(`âš ï¸ éƒ¨åˆ†é¢˜ç›®é¢„åŠ è½½å¤±è´¥`);
    } finally {
      preloadPromise = null; // é‡ç½®Promise
    }
  }

  // ====== åŠ è½½å¹¶æ˜¾ç¤ºé¢˜ç›®ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰ ======
  async function loadAndShowQuestion(idx) {
    const file = fileList[idx];
    currentFile = file;

    $('#question-content').html('<p>åŠ è½½ä¸­...</p>');
    $('#preload-status').text('');

    try {
      // åŠ è½½å½“å‰é¢˜ç›®
      const question = await loadSingleQuestion(file);
      showQuestion(question);
      
      // å¼‚æ­¥é¢„åŠ è½½å‰å4é¢˜ï¼ˆä¸é˜»å¡å½“å‰é¢˜ç›®æ˜¾ç¤ºï¼‰
      setTimeout(() => preloadSurroundingQuestions(idx), 500);
    } catch (err) {
      $('#question-content').html(`<p style="color:red;">åŠ è½½é¢˜ç›®å¤±è´¥ï¼š${err.message}</p>`);
      console.error('åŠ è½½é¢˜ç›®è¯¦æƒ…å¤±è´¥ï¼š', err);
    }
  }

  // ====== æ˜¾ç¤ºé¢˜ç›®å†…å®¹ ======
  function showQuestion(q) {
    let optionsHtml = '';
    q.option.forEach(opt => {
      const key = opt.charAt(0);
      optionsHtml += `<label><input type="radio" name="answer" value="${key}"> ${opt}</label><br>`;
    });

    let html = `
      <h3>${q.test}</h3>
      <div>${optionsHtml}</div>
      <button id="submit-btn">æäº¤ç­”æ¡ˆ</button>
      <button id="collect-btn">${isCollected(q) ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}</button>
      <div id="result"></div>
      <div id="analysis" style="margin-top:10px; display:none;">
        <p><strong>è§£æï¼š</strong>${q.point || ''}</p>
        ${q.discuss ? `<p><strong>è®¨è®ºï¼š</strong>${q.discuss}</p>` : ''}
      </div>
    `;
    $('#question-content').html(html);

    // ç»‘å®šäº‹ä»¶
    $('#submit-btn').on('click', () => submitAnswer(q));
    $('#collect-btn').on('click', () => toggleCollect(q));
  }

  function isCollected(q) {
    return collected.some(c => c.filename === currentFile.name);
  }

  function toggleCollect(q) {
    const idx = collected.findIndex(c => c.filename === currentFile.name);
    if (idx >= 0) {
      collected.splice(idx, 1);
    } else {
      collected.push({ filename: currentFile.name, ...q });
    }
    localStorage.setItem(STORAGE.collected, JSON.stringify(collected));
    renderQuestionList();
    $('#collect-btn').text(isCollected(q) ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—');
  }

  function submitAnswer(q) {
    const selected = $('input[name="answer"]:checked').val();
    if (!selected) {
      alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
      return;
    }

    const correct = selected === q.answer;
    $('#result').html(`
      <p style="color:${correct ? 'green' : 'red'};">
        ${correct ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯ï¼'} æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}
      </p>
    `);
    $('#analysis').show();

    if (!finished.includes(currentFile.name)) {
      finished.push(currentFile.name);
      localStorage.setItem(STORAGE.finished, JSON.stringify(finished));
      renderQuestionList();
    }

    if (fileList.indexOf(currentFile) < fileList.length - 1) {
      $('#question-content').append('<br><button id="next-btn">ä¸‹ä¸€é¢˜</button>');
      $('#next-btn').on('click', () => {
        const nextIdx = fileList.indexOf(currentFile) + 1;
        loadAndShowQuestion(nextIdx);
      });
    }
  }

  // ====== æ”¶è—åˆ—è¡¨ ======
  $('#show-collect').on('click', function() {
    let html = '';
    if (collected.length === 0) {
      html = '<p>æš‚æ— æ”¶è—</p>';
    } else {
      collected.forEach((item, i) => {
        html += `<div class="collect-item" data-i="${i}" style="padding:8px; border-bottom:1px solid #ddd; cursor:pointer;">
          ${item.test.substring(0, 50)}...
        </div>`;
      });
    }
    $('#collect-items').html(html);
    $('#collect-modal').show();

    $('.collect-item').on('click', function() {
      const i = $(this).data('i');
      const item = collected[i];
      const file = fileList.find(f => f.name === item.filename);
      if (file) {
        const idx = fileList.indexOf(file);
        loadAndShowQuestion(idx);
        $('#collect-modal').hide();
      }
    });
  });

  $('#close-collect').on('click', () => $('#collect-modal').hide());

  // ====== é‡ç½® ======
  $('#reset-all').on('click', function() {
    if (confirm('ç¡®å®šé‡ç½®æ‰€æœ‰è¿›åº¦ã€æ”¶è—å’Œç¼“å­˜ï¼Ÿ')) {
      localStorage.removeItem(STORAGE.finished);
      localStorage.removeItem(STORAGE.collected);
      localStorage.removeItem(STORAGE.questionsCache); // æ¸…ç©ºé¢˜ç›®ç¼“å­˜
      finished = [];
      collected = [];
      questionsCache = {}; // æ¸…ç©ºå†…å­˜ç¼“å­˜
      renderQuestionList();
      $('#question-content').text('è¯·é€‰æ‹©ä¸€é“é¢˜ç›®å¼€å§‹ç­”é¢˜');
      $('#preload-status').text('');
    }
  });

  // ====== åˆå§‹åŒ– ======
  loadConfig();
  initQuestionsCache(); // åˆå§‹åŒ–é¢˜ç›®ç¼“å­˜
});
</script>

</body>
</html>